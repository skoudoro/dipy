<!DOCTYPE html>
<!-- Generated by Cython 0.27.3 -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cython: ssdmetric.pyx</title>
    <style type="text/css">
    
body.cython { font-family: courier; font-size: 12; }

.cython.tag  {  }
.cython.line { margin: 0em }
.cython.code { font-size: 9; color: #444444; display: none; margin: 0px 0px 0px 8px; border-left: 8px none; }

.cython.line .run { background-color: #B0FFB0; }
.cython.line .mis { background-color: #FFB0B0; }
.cython.code.run  { border-left: 8px solid #B0FFB0; }
.cython.code.mis  { border-left: 8px solid #FFB0B0; }

.cython.code .py_c_api  { color: red; }
.cython.code .py_macro_api  { color: #FF7000; }
.cython.code .pyx_c_api  { color: #FF3000; }
.cython.code .pyx_macro_api  { color: #FF7000; }
.cython.code .refnanny  { color: #FFA000; }
.cython.code .trace  { color: #FFA000; }
.cython.code .error_goto  { color: #FFA000; }

.cython.code .coerce  { color: #008000; border: 1px dotted #008000 }
.cython.code .py_attr { color: #FF0000; font-weight: bold; }
.cython.code .c_attr  { color: #0000FF; }
.cython.code .py_call { color: #FF0000; font-weight: bold; }
.cython.code .c_call  { color: #0000FF; }

.cython.score-0 {background-color: #FFFFff;}
.cython.score-1 {background-color: #FFFFe7;}
.cython.score-2 {background-color: #FFFFd4;}
.cython.score-3 {background-color: #FFFFc4;}
.cython.score-4 {background-color: #FFFFb6;}
.cython.score-5 {background-color: #FFFFaa;}
.cython.score-6 {background-color: #FFFF9f;}
.cython.score-7 {background-color: #FFFF96;}
.cython.score-8 {background-color: #FFFF8d;}
.cython.score-9 {background-color: #FFFF86;}
.cython.score-10 {background-color: #FFFF7f;}
.cython.score-11 {background-color: #FFFF79;}
.cython.score-12 {background-color: #FFFF73;}
.cython.score-13 {background-color: #FFFF6e;}
.cython.score-14 {background-color: #FFFF6a;}
.cython.score-15 {background-color: #FFFF66;}
.cython.score-16 {background-color: #FFFF62;}
.cython.score-17 {background-color: #FFFF5e;}
.cython.score-18 {background-color: #FFFF5b;}
.cython.score-19 {background-color: #FFFF57;}
.cython.score-20 {background-color: #FFFF55;}
.cython.score-21 {background-color: #FFFF52;}
.cython.score-22 {background-color: #FFFF4f;}
.cython.score-23 {background-color: #FFFF4d;}
.cython.score-24 {background-color: #FFFF4b;}
.cython.score-25 {background-color: #FFFF48;}
.cython.score-26 {background-color: #FFFF46;}
.cython.score-27 {background-color: #FFFF44;}
.cython.score-28 {background-color: #FFFF43;}
.cython.score-29 {background-color: #FFFF41;}
.cython.score-30 {background-color: #FFFF3f;}
.cython.score-31 {background-color: #FFFF3e;}
.cython.score-32 {background-color: #FFFF3c;}
.cython.score-33 {background-color: #FFFF3b;}
.cython.score-34 {background-color: #FFFF39;}
.cython.score-35 {background-color: #FFFF38;}
.cython.score-36 {background-color: #FFFF37;}
.cython.score-37 {background-color: #FFFF36;}
.cython.score-38 {background-color: #FFFF35;}
.cython.score-39 {background-color: #FFFF34;}
.cython.score-40 {background-color: #FFFF33;}
.cython.score-41 {background-color: #FFFF32;}
.cython.score-42 {background-color: #FFFF31;}
.cython.score-43 {background-color: #FFFF30;}
.cython.score-44 {background-color: #FFFF2f;}
.cython.score-45 {background-color: #FFFF2e;}
.cython.score-46 {background-color: #FFFF2d;}
.cython.score-47 {background-color: #FFFF2c;}
.cython.score-48 {background-color: #FFFF2b;}
.cython.score-49 {background-color: #FFFF2b;}
.cython.score-50 {background-color: #FFFF2a;}
.cython.score-51 {background-color: #FFFF29;}
.cython.score-52 {background-color: #FFFF29;}
.cython.score-53 {background-color: #FFFF28;}
.cython.score-54 {background-color: #FFFF27;}
.cython.score-55 {background-color: #FFFF27;}
.cython.score-56 {background-color: #FFFF26;}
.cython.score-57 {background-color: #FFFF26;}
.cython.score-58 {background-color: #FFFF25;}
.cython.score-59 {background-color: #FFFF24;}
.cython.score-60 {background-color: #FFFF24;}
.cython.score-61 {background-color: #FFFF23;}
.cython.score-62 {background-color: #FFFF23;}
.cython.score-63 {background-color: #FFFF22;}
.cython.score-64 {background-color: #FFFF22;}
.cython.score-65 {background-color: #FFFF22;}
.cython.score-66 {background-color: #FFFF21;}
.cython.score-67 {background-color: #FFFF21;}
.cython.score-68 {background-color: #FFFF20;}
.cython.score-69 {background-color: #FFFF20;}
.cython.score-70 {background-color: #FFFF1f;}
.cython.score-71 {background-color: #FFFF1f;}
.cython.score-72 {background-color: #FFFF1f;}
.cython.score-73 {background-color: #FFFF1e;}
.cython.score-74 {background-color: #FFFF1e;}
.cython.score-75 {background-color: #FFFF1e;}
.cython.score-76 {background-color: #FFFF1d;}
.cython.score-77 {background-color: #FFFF1d;}
.cython.score-78 {background-color: #FFFF1c;}
.cython.score-79 {background-color: #FFFF1c;}
.cython.score-80 {background-color: #FFFF1c;}
.cython.score-81 {background-color: #FFFF1c;}
.cython.score-82 {background-color: #FFFF1b;}
.cython.score-83 {background-color: #FFFF1b;}
.cython.score-84 {background-color: #FFFF1b;}
.cython.score-85 {background-color: #FFFF1a;}
.cython.score-86 {background-color: #FFFF1a;}
.cython.score-87 {background-color: #FFFF1a;}
.cython.score-88 {background-color: #FFFF1a;}
.cython.score-89 {background-color: #FFFF19;}
.cython.score-90 {background-color: #FFFF19;}
.cython.score-91 {background-color: #FFFF19;}
.cython.score-92 {background-color: #FFFF19;}
.cython.score-93 {background-color: #FFFF18;}
.cython.score-94 {background-color: #FFFF18;}
.cython.score-95 {background-color: #FFFF18;}
.cython.score-96 {background-color: #FFFF18;}
.cython.score-97 {background-color: #FFFF17;}
.cython.score-98 {background-color: #FFFF17;}
.cython.score-99 {background-color: #FFFF17;}
.cython.score-100 {background-color: #FFFF17;}
.cython.score-101 {background-color: #FFFF16;}
.cython.score-102 {background-color: #FFFF16;}
.cython.score-103 {background-color: #FFFF16;}
.cython.score-104 {background-color: #FFFF16;}
.cython.score-105 {background-color: #FFFF16;}
.cython.score-106 {background-color: #FFFF15;}
.cython.score-107 {background-color: #FFFF15;}
.cython.score-108 {background-color: #FFFF15;}
.cython.score-109 {background-color: #FFFF15;}
.cython.score-110 {background-color: #FFFF15;}
.cython.score-111 {background-color: #FFFF15;}
.cython.score-112 {background-color: #FFFF14;}
.cython.score-113 {background-color: #FFFF14;}
.cython.score-114 {background-color: #FFFF14;}
.cython.score-115 {background-color: #FFFF14;}
.cython.score-116 {background-color: #FFFF14;}
.cython.score-117 {background-color: #FFFF14;}
.cython.score-118 {background-color: #FFFF13;}
.cython.score-119 {background-color: #FFFF13;}
.cython.score-120 {background-color: #FFFF13;}
.cython.score-121 {background-color: #FFFF13;}
.cython.score-122 {background-color: #FFFF13;}
.cython.score-123 {background-color: #FFFF13;}
.cython.score-124 {background-color: #FFFF13;}
.cython.score-125 {background-color: #FFFF12;}
.cython.score-126 {background-color: #FFFF12;}
.cython.score-127 {background-color: #FFFF12;}
.cython.score-128 {background-color: #FFFF12;}
.cython.score-129 {background-color: #FFFF12;}
.cython.score-130 {background-color: #FFFF12;}
.cython.score-131 {background-color: #FFFF12;}
.cython.score-132 {background-color: #FFFF11;}
.cython.score-133 {background-color: #FFFF11;}
.cython.score-134 {background-color: #FFFF11;}
.cython.score-135 {background-color: #FFFF11;}
.cython.score-136 {background-color: #FFFF11;}
.cython.score-137 {background-color: #FFFF11;}
.cython.score-138 {background-color: #FFFF11;}
.cython.score-139 {background-color: #FFFF11;}
.cython.score-140 {background-color: #FFFF11;}
.cython.score-141 {background-color: #FFFF10;}
.cython.score-142 {background-color: #FFFF10;}
.cython.score-143 {background-color: #FFFF10;}
.cython.score-144 {background-color: #FFFF10;}
.cython.score-145 {background-color: #FFFF10;}
.cython.score-146 {background-color: #FFFF10;}
.cython.score-147 {background-color: #FFFF10;}
.cython.score-148 {background-color: #FFFF10;}
.cython.score-149 {background-color: #FFFF10;}
.cython.score-150 {background-color: #FFFF0f;}
.cython.score-151 {background-color: #FFFF0f;}
.cython.score-152 {background-color: #FFFF0f;}
.cython.score-153 {background-color: #FFFF0f;}
.cython.score-154 {background-color: #FFFF0f;}
.cython.score-155 {background-color: #FFFF0f;}
.cython.score-156 {background-color: #FFFF0f;}
.cython.score-157 {background-color: #FFFF0f;}
.cython.score-158 {background-color: #FFFF0f;}
.cython.score-159 {background-color: #FFFF0f;}
.cython.score-160 {background-color: #FFFF0f;}
.cython.score-161 {background-color: #FFFF0e;}
.cython.score-162 {background-color: #FFFF0e;}
.cython.score-163 {background-color: #FFFF0e;}
.cython.score-164 {background-color: #FFFF0e;}
.cython.score-165 {background-color: #FFFF0e;}
.cython.score-166 {background-color: #FFFF0e;}
.cython.score-167 {background-color: #FFFF0e;}
.cython.score-168 {background-color: #FFFF0e;}
.cython.score-169 {background-color: #FFFF0e;}
.cython.score-170 {background-color: #FFFF0e;}
.cython.score-171 {background-color: #FFFF0e;}
.cython.score-172 {background-color: #FFFF0e;}
.cython.score-173 {background-color: #FFFF0d;}
.cython.score-174 {background-color: #FFFF0d;}
.cython.score-175 {background-color: #FFFF0d;}
.cython.score-176 {background-color: #FFFF0d;}
.cython.score-177 {background-color: #FFFF0d;}
.cython.score-178 {background-color: #FFFF0d;}
.cython.score-179 {background-color: #FFFF0d;}
.cython.score-180 {background-color: #FFFF0d;}
.cython.score-181 {background-color: #FFFF0d;}
.cython.score-182 {background-color: #FFFF0d;}
.cython.score-183 {background-color: #FFFF0d;}
.cython.score-184 {background-color: #FFFF0d;}
.cython.score-185 {background-color: #FFFF0d;}
.cython.score-186 {background-color: #FFFF0d;}
.cython.score-187 {background-color: #FFFF0c;}
.cython.score-188 {background-color: #FFFF0c;}
.cython.score-189 {background-color: #FFFF0c;}
.cython.score-190 {background-color: #FFFF0c;}
.cython.score-191 {background-color: #FFFF0c;}
.cython.score-192 {background-color: #FFFF0c;}
.cython.score-193 {background-color: #FFFF0c;}
.cython.score-194 {background-color: #FFFF0c;}
.cython.score-195 {background-color: #FFFF0c;}
.cython.score-196 {background-color: #FFFF0c;}
.cython.score-197 {background-color: #FFFF0c;}
.cython.score-198 {background-color: #FFFF0c;}
.cython.score-199 {background-color: #FFFF0c;}
.cython.score-200 {background-color: #FFFF0c;}
.cython.score-201 {background-color: #FFFF0c;}
.cython.score-202 {background-color: #FFFF0c;}
.cython.score-203 {background-color: #FFFF0b;}
.cython.score-204 {background-color: #FFFF0b;}
.cython.score-205 {background-color: #FFFF0b;}
.cython.score-206 {background-color: #FFFF0b;}
.cython.score-207 {background-color: #FFFF0b;}
.cython.score-208 {background-color: #FFFF0b;}
.cython.score-209 {background-color: #FFFF0b;}
.cython.score-210 {background-color: #FFFF0b;}
.cython.score-211 {background-color: #FFFF0b;}
.cython.score-212 {background-color: #FFFF0b;}
.cython.score-213 {background-color: #FFFF0b;}
.cython.score-214 {background-color: #FFFF0b;}
.cython.score-215 {background-color: #FFFF0b;}
.cython.score-216 {background-color: #FFFF0b;}
.cython.score-217 {background-color: #FFFF0b;}
.cython.score-218 {background-color: #FFFF0b;}
.cython.score-219 {background-color: #FFFF0b;}
.cython.score-220 {background-color: #FFFF0b;}
.cython.score-221 {background-color: #FFFF0b;}
.cython.score-222 {background-color: #FFFF0a;}
.cython.score-223 {background-color: #FFFF0a;}
.cython.score-224 {background-color: #FFFF0a;}
.cython.score-225 {background-color: #FFFF0a;}
.cython.score-226 {background-color: #FFFF0a;}
.cython.score-227 {background-color: #FFFF0a;}
.cython.score-228 {background-color: #FFFF0a;}
.cython.score-229 {background-color: #FFFF0a;}
.cython.score-230 {background-color: #FFFF0a;}
.cython.score-231 {background-color: #FFFF0a;}
.cython.score-232 {background-color: #FFFF0a;}
.cython.score-233 {background-color: #FFFF0a;}
.cython.score-234 {background-color: #FFFF0a;}
.cython.score-235 {background-color: #FFFF0a;}
.cython.score-236 {background-color: #FFFF0a;}
.cython.score-237 {background-color: #FFFF0a;}
.cython.score-238 {background-color: #FFFF0a;}
.cython.score-239 {background-color: #FFFF0a;}
.cython.score-240 {background-color: #FFFF0a;}
.cython.score-241 {background-color: #FFFF0a;}
.cython.score-242 {background-color: #FFFF0a;}
.cython.score-243 {background-color: #FFFF0a;}
.cython.score-244 {background-color: #FFFF0a;}
.cython.score-245 {background-color: #FFFF0a;}
.cython.score-246 {background-color: #FFFF09;}
.cython.score-247 {background-color: #FFFF09;}
.cython.score-248 {background-color: #FFFF09;}
.cython.score-249 {background-color: #FFFF09;}
.cython.score-250 {background-color: #FFFF09;}
.cython.score-251 {background-color: #FFFF09;}
.cython.score-252 {background-color: #FFFF09;}
.cython.score-253 {background-color: #FFFF09;}
.cython.score-254 {background-color: #FFFF09;}
.cython .hll { background-color: #ffffcc }
.cython  { background: #f8f8f8; }
.cython .c { color: #408080; font-style: italic } /* Comment */
.cython .err { border: 1px solid #FF0000 } /* Error */
.cython .k { color: #008000; font-weight: bold } /* Keyword */
.cython .o { color: #666666 } /* Operator */
.cython .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.cython .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cython .cp { color: #BC7A00 } /* Comment.Preproc */
.cython .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.cython .c1 { color: #408080; font-style: italic } /* Comment.Single */
.cython .cs { color: #408080; font-style: italic } /* Comment.Special */
.cython .gd { color: #A00000 } /* Generic.Deleted */
.cython .ge { font-style: italic } /* Generic.Emph */
.cython .gr { color: #FF0000 } /* Generic.Error */
.cython .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.cython .gi { color: #00A000 } /* Generic.Inserted */
.cython .go { color: #888888 } /* Generic.Output */
.cython .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.cython .gs { font-weight: bold } /* Generic.Strong */
.cython .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.cython .gt { color: #0044DD } /* Generic.Traceback */
.cython .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.cython .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.cython .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.cython .kp { color: #008000 } /* Keyword.Pseudo */
.cython .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.cython .kt { color: #B00040 } /* Keyword.Type */
.cython .m { color: #666666 } /* Literal.Number */
.cython .s { color: #BA2121 } /* Literal.String */
.cython .na { color: #7D9029 } /* Name.Attribute */
.cython .nb { color: #008000 } /* Name.Builtin */
.cython .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.cython .no { color: #880000 } /* Name.Constant */
.cython .nd { color: #AA22FF } /* Name.Decorator */
.cython .ni { color: #999999; font-weight: bold } /* Name.Entity */
.cython .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.cython .nf { color: #0000FF } /* Name.Function */
.cython .nl { color: #A0A000 } /* Name.Label */
.cython .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.cython .nt { color: #008000; font-weight: bold } /* Name.Tag */
.cython .nv { color: #19177C } /* Name.Variable */
.cython .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.cython .w { color: #bbbbbb } /* Text.Whitespace */
.cython .mb { color: #666666 } /* Literal.Number.Bin */
.cython .mf { color: #666666 } /* Literal.Number.Float */
.cython .mh { color: #666666 } /* Literal.Number.Hex */
.cython .mi { color: #666666 } /* Literal.Number.Integer */
.cython .mo { color: #666666 } /* Literal.Number.Oct */
.cython .sa { color: #BA2121 } /* Literal.String.Affix */
.cython .sb { color: #BA2121 } /* Literal.String.Backtick */
.cython .sc { color: #BA2121 } /* Literal.String.Char */
.cython .dl { color: #BA2121 } /* Literal.String.Delimiter */
.cython .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.cython .s2 { color: #BA2121 } /* Literal.String.Double */
.cython .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.cython .sh { color: #BA2121 } /* Literal.String.Heredoc */
.cython .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.cython .sx { color: #008000 } /* Literal.String.Other */
.cython .sr { color: #BB6688 } /* Literal.String.Regex */
.cython .s1 { color: #BA2121 } /* Literal.String.Single */
.cython .ss { color: #19177C } /* Literal.String.Symbol */
.cython .bp { color: #008000 } /* Name.Builtin.Pseudo */
.cython .fm { color: #0000FF } /* Name.Function.Magic */
.cython .vc { color: #19177C } /* Name.Variable.Class */
.cython .vg { color: #19177C } /* Name.Variable.Global */
.cython .vi { color: #19177C } /* Name.Variable.Instance */
.cython .vm { color: #19177C } /* Name.Variable.Magic */
.cython .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
    <script>
    function toggleDiv(id) {
        theDiv = id.nextElementSibling
        if (theDiv.style.display != 'block') theDiv.style.display = 'block';
        else theDiv.style.display = 'none';
    }
    </script>
</head>
<body class="cython">
<p><span style="border-bottom: solid 1px grey;">Generated by Cython 0.27.3</span></p>
<p>
    <span style="background-color: #FFFF00">Yellow lines</span> hint at Python interaction.<br />
    Click on a line that starts with a "<code>+</code>" to see the C code that Cython generated for it.
</p>
<p>Raw output: <a href="ssdmetric.c">ssdmetric.c</a></p>
<div class="cython"><pre class="cython line score-8" onclick='toggleDiv(this)'>+<span class="">001</span>: <span class="c">#!python</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_test, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">002</span>: <span class="c">#cython: boundscheck=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">003</span>: <span class="c">#cython: wraparound=False</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">004</span>: <span class="c">#cython: cdivision=True</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">005</span>: </pre>
<pre class="cython line score-8" onclick='toggleDiv(this)'>+<span class="">006</span>: <span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_numpy, 0, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 6, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_np, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 6, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">007</span>: <span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">cnp</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">008</span>: <span class="k">cimport</span> <span class="nn">cython</span></pre>
<pre class="cython line score-16" onclick='toggleDiv(this)'>+<span class="">009</span>: <span class="k">import</span> <span class="nn">numpy.random</span> <span class="k">as</span> <span class="nn">random</span></pre>
<pre class='cython code score-16 '>  __pyx_t_1 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s__41);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s__41);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 0, __pyx_n_s__41);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_numpy_random, __pyx_t_1, -1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_random, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 9, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">010</span>: <span class="k">from</span> <span class="nn">dipy.align.fused_types</span> <span class="k">cimport</span> <span class="n">floating</span></pre>
<pre class="cython line score-19" onclick='toggleDiv(this)'>+<span class="">011</span>: <span class="k">from</span> <span class="nn">dipy.align</span> <span class="k">import</span> <span class="n">vector_fields</span> <span class="k">as</span> <span class="n">vf</span></pre>
<pre class='cython code score-19 '>  __pyx_t_2 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_vector_fields);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_vector_fields);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_2, 0, __pyx_n_s_vector_fields);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_dipy_align, __pyx_t_2, -1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_ImportFrom</span>(__pyx_t_1, __pyx_n_s_vector_fields);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_vf, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 11, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">012</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">013</span>: <span class="k">from</span> <span class="nn">dipy.align.vector_fields</span> <span class="k">cimport</span><span class="p">(</span><span class="n">_apply_affine_3d_x0</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">014</span>:                                       <span class="n">_apply_affine_3d_x1</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">015</span>:                                       <span class="n">_apply_affine_3d_x2</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">016</span>:                                       <span class="n">_apply_affine_2d_x0</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">017</span>:                                       <span class="n">_apply_affine_2d_x1</span><span class="p">)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">018</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">019</span>: <span class="k">from</span> <span class="nn">dipy.align.transforms</span> <span class="k">cimport</span> <span class="p">(</span><span class="n">Transform</span><span class="p">)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">020</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">021</span>: <span class="k">cdef</span> <span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;dpy_math.h&quot;</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">022</span>:     <span class="n">double</span> <span class="n">cos</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">023</span>:     <span class="n">double</span> <span class="n">sin</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">024</span>:     <span class="n">double</span> <span class="n">log</span><span class="p">(</span><span class="n">double</span><span class="p">)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">025</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">026</span>: </pre>
<pre class="cython line score-15" onclick='toggleDiv(this)'>+<span class="">027</span>: <span class="k">class</span> <span class="nc">SSDMetric</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre>
<pre class='cython code score-15 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_CalculateMetaclass</span>(NULL, __pyx_tuple__42);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 27, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = __Pyx_Py3MetaclassPrepare(__pyx_t_1, __pyx_tuple__42, __pyx_n_s_SSDMetric, __pyx_n_s_SSDMetric, (PyObject *) NULL, __pyx_n_s_dipy_align_ssdmetric, (PyObject *) NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 27, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
/* … */
  __pyx_tuple__42 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_builtin_object);<span class='error_goto'> if (unlikely(!__pyx_tuple__42)) __PYX_ERR(0, 27, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__42);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__42);
/* … */
  __pyx_t_3 = __Pyx_Py3ClassCreate(__pyx_t_1, __pyx_n_s_SSDMetric, __pyx_tuple__42, __pyx_t_2, NULL, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 27, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_SSDMetric, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 27, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-18" onclick='toggleDiv(this)'>+<span class="">028</span>:     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre>
<pre class='cython code score-18 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_1__init__(PyObject *__pyx_self, PyObject *__pyx_v_self); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric___init__[] = " Compute ssd metric and derivatives of transformation matrix.\n\n        Parameters\n        ----------\n        None\n\n        Notes\n        --------\n        We need this class in cython to allow __gradient_dense_2d and\n        _gradient_dense_3d to use a nogil Jacobian function (obtained\n        from an instance of the Transform class), which allows us to evaluate\n        Jacobians at all the sampling points (maybe the full grid) inside a\n        nogil loop.\n\n        The reason we need a class is to encapsulate all the parameters related to transformation matrix\n\n        ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_1__init__ = {"__init__", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_1__init__, METH_O, __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric___init__};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_1__init__(PyObject *__pyx_self, PyObject *__pyx_v_self) {
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__init__ (wrapper)", 0);
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric___init__(__pyx_self, ((PyObject *)__pyx_v_self));

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self) {
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__init__", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__43 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_n_s_self);<span class='error_goto'> if (unlikely(!__pyx_tuple__43)) __PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__43);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__43);
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_CyFunction_NewEx</span>(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_1__init__, 0, __pyx_n_s_SSDMetric___init, NULL, __pyx_n_s_dipy_align_ssdmetric, __pyx_d, ((PyObject *)__pyx_codeobj__44));<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyObject_SetItem</span>(__pyx_t_2, __pyx_n_s_init, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 28, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_codeobj__44 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(1, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__43, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_init, 28, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__44)) __PYX_ERR(0, 28, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">029</span>:         <span class="s">r&quot;&quot;&quot; Compute ssd metric and derivatives of transformation matrix.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">030</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">031</span>: <span class="s">        Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">032</span>: <span class="s">        ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">033</span>: <span class="s">        None</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">034</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">035</span>: <span class="s">        Notes</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">036</span>: <span class="s">        --------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">037</span>: <span class="s">        We need this class in cython to allow __gradient_dense_2d and</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">038</span>: <span class="s">        _gradient_dense_3d to use a nogil Jacobian function (obtained</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">039</span>: <span class="s">        from an instance of the Transform class), which allows us to evaluate</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">040</span>: <span class="s">        Jacobians at all the sampling points (maybe the full grid) inside a</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">041</span>: <span class="s">        nogil loop.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">042</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">043</span>: <span class="s">        The reason we need a class is to encapsulate all the parameters related to transformation matrix</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">044</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">045</span>: <span class="s">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">046</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">setup_called</span> <span class="o">=</span> <span class="bp">False</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup_called, Py_False) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 46, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">047</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">048</span>: </pre>
<pre class="cython line score-86" onclick='toggleDiv(this)'>+<span class="">049</span>:     <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span><span class="n">smask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">mmask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-86 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_3setup(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_2setup[] = " Initializes static and moving images\n\n        Parameters\n        ----------\n        static : array\n            static image\n        moving : array\n            moving image\n        \n        ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_3setup = {"setup", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_3setup, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_2setup};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_3setup(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_self = 0;
  PyObject *__pyx_v_static = 0;
  PyObject *__pyx_v_moving = 0;
  PyObject *__pyx_v_smask = 0;
  PyObject *__pyx_v_mmask = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("setup (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_self,&amp;__pyx_n_s_static,&amp;__pyx_n_s_moving,&amp;__pyx_n_s_smask,&amp;__pyx_n_s_mmask,0};
    PyObject* values[5] = {0,0,0,0,0};
    values[3] = ((PyObject *)((PyObject *)Py_None));
    values[4] = ((PyObject *)((PyObject *)Py_None));
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_static)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("setup", 0, 3, 5, 1); <span class='error_goto'>__PYX_ERR(0, 49, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_moving)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("setup", 0, 3, 5, 2); <span class='error_goto'>__PYX_ERR(0, 49, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_smask);
          if (value) { values[3] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mmask);
          if (value) { values[4] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "setup") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 49, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_self = values[0];
    __pyx_v_static = values[1];
    __pyx_v_moving = values[2];
    __pyx_v_smask = values[3];
    __pyx_v_mmask = values[4];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("setup", 0, 3, 5, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 49, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.setup", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_2setup(__pyx_self, __pyx_v_self, __pyx_v_static, __pyx_v_moving, __pyx_v_smask, __pyx_v_mmask);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_2setup(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_static, PyObject *__pyx_v_moving, PyObject *__pyx_v_smask, PyObject *__pyx_v_mmask) {
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("setup", 0);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_smask);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_mmask);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.setup", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_smask);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_mmask);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__45 = <span class='py_c_api'>PyTuple_Pack</span>(5, __pyx_n_s_self, __pyx_n_s_static, __pyx_n_s_moving, __pyx_n_s_smask, __pyx_n_s_mmask);<span class='error_goto'> if (unlikely(!__pyx_tuple__45)) __PYX_ERR(0, 49, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__45);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__45);
  __pyx_codeobj__46 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(5, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__45, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_setup, 49, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__46)) __PYX_ERR(0, 49, __pyx_L1_error)</span>
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_CyFunction_NewEx</span>(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_3setup, 0, __pyx_n_s_SSDMetric_setup, NULL, __pyx_n_s_dipy_align_ssdmetric, __pyx_d, ((PyObject *)__pyx_codeobj__46));<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 49, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_c_api'>__Pyx_CyFunction_SetDefaultsTuple</span>(__pyx_t_3, __pyx_tuple__47);
  if (<span class='py_c_api'>PyObject_SetItem</span>(__pyx_t_2, __pyx_n_s_setup, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 49, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_tuple__47 = <span class='py_c_api'>PyTuple_Pack</span>(2, ((PyObject *)Py_None), ((PyObject *)Py_None));<span class='error_goto'> if (unlikely(!__pyx_tuple__47)) __PYX_ERR(0, 49, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__47);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__47);
</pre><pre class="cython line score-0">&#xA0;<span class="">050</span>:         <span class="s">r&quot;&quot;&quot; Initializes static and moving images</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">051</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">052</span>: <span class="s">        Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">053</span>: <span class="s">        ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">054</span>: <span class="s">        static : array</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">055</span>: <span class="s">            static image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">056</span>: <span class="s">        moving : array</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">057</span>: <span class="s">            moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">058</span>: <span class="s">        </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">059</span>: <span class="s">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">060</span>: </pre>
<pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">061</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span> <span class="o">=</span> <span class="bp">None</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient, Py_None) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 61, __pyx_L1_error)</span>
</pre><pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">062</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="bp">None</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_delta, Py_None) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 62, __pyx_L1_error)</span>
</pre><pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">063</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">metric_grad</span> <span class="o">=</span> <span class="bp">None</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_metric_grad, Py_None) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 63, __pyx_L1_error)</span>
</pre><pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">064</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">metric_val</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_metric_val, __pyx_int_0) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 64, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">065</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">066</span>:         <span class="k">if</span> <span class="n">smask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_1 = (__pyx_v_smask == Py_None);
  __pyx_t_2 = (__pyx_t_1 != 0);
  if (__pyx_t_2) {
/* … */
  }
</pre><pre class="cython line score-43" onclick='toggleDiv(this)'>+<span class="">067</span>:             <span class="n">smask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">static</span><span class="p">)</span></pre>
<pre class='cython code score-43 '>    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_ones_like);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
      __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
      if (likely(__pyx_t_4)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_v_static);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_5)) {
        PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_v_static};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_5)) {
        PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_v_static};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      } else
      #endif
      {
        __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_static);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_static);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0+1, __pyx_v_static);
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_6, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 67, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_smask, __pyx_t_3);
    __pyx_t_3 = 0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">068</span>:         <span class="k">if</span> <span class="n">mmask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>  __pyx_t_2 = (__pyx_v_mmask == Py_None);
  __pyx_t_1 = (__pyx_t_2 != 0);
  if (__pyx_t_1) {
/* … */
  }
</pre><pre class="cython line score-43" onclick='toggleDiv(this)'>+<span class="">069</span>:             <span class="n">mmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span></pre>
<pre class='cython code score-43 '>    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_ones_like);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_6))) {
      __pyx_t_5 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_6);
      if (likely(__pyx_t_5)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_6);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_6, __pyx_v_moving);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_6)) {
        PyObject *__pyx_temp[2] = {__pyx_t_5, __pyx_v_moving};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_6, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_6)) {
        PyObject *__pyx_temp[2] = {__pyx_t_5, __pyx_v_moving};
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_6, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      } else
      #endif
      {
        __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_moving);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_moving);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0+1, __pyx_v_moving);
        __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_6, __pyx_t_4, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_v_mmask, __pyx_t_3);
    __pyx_t_3 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">070</span>: </pre>
<pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">071</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">setup_called</span> <span class="o">=</span> <span class="bp">True</span></pre>
<pre class='cython code score-2 '>  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup_called, Py_True) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 71, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">072</span>: </pre>
<pre class="cython line score-82" onclick='toggleDiv(this)'>+<span class="">073</span>:     <span class="k">def</span> <span class="nf">update_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span><span class="n">smask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mmask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-82 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_5update_delta(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_4update_delta[] = "\n        Computes delta for static and moving points\n\n        Parameters:\n        -----------\n        sval: array, shape (n, ) or (S, R, C) - intensities of static image either sampled or full image\n\n        mval: array, shape (n,) or (S, R, C) - intensities of moving image  either sampled\n              of full image\n        ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_5update_delta = {"update_delta", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_5update_delta, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_4update_delta};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_5update_delta(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_self = 0;
  PyObject *__pyx_v_sval = 0;
  PyObject *__pyx_v_mval = 0;
  CYTHON_UNUSED PyObject *__pyx_v_smask = 0;
  CYTHON_UNUSED PyObject *__pyx_v_mmask = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_delta (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_self,&amp;__pyx_n_s_sval,&amp;__pyx_n_s_mval,&amp;__pyx_n_s_smask,&amp;__pyx_n_s_mmask,0};
    PyObject* values[5] = {0,0,0,0,0};
    values[3] = ((PyObject *)((PyObject *)Py_None));
    values[4] = ((PyObject *)((PyObject *)Py_None));
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_sval)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_delta", 0, 3, 5, 1); <span class='error_goto'>__PYX_ERR(0, 73, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mval)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_delta", 0, 3, 5, 2); <span class='error_goto'>__PYX_ERR(0, 73, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_smask);
          if (value) { values[3] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mmask);
          if (value) { values[4] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "update_delta") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 73, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_self = values[0];
    __pyx_v_sval = values[1];
    __pyx_v_mval = values[2];
    __pyx_v_smask = values[3];
    __pyx_v_mmask = values[4];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_delta", 0, 3, 5, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 73, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_delta", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_4update_delta(__pyx_self, __pyx_v_self, __pyx_v_sval, __pyx_v_mval, __pyx_v_smask, __pyx_v_mmask);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_4update_delta(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_sval, PyObject *__pyx_v_mval, CYTHON_UNUSED PyObject *__pyx_v_smask, CYTHON_UNUSED PyObject *__pyx_v_mmask) {
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_delta", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_delta", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__48 = <span class='py_c_api'>PyTuple_Pack</span>(5, __pyx_n_s_self, __pyx_n_s_sval, __pyx_n_s_mval, __pyx_n_s_smask, __pyx_n_s_mmask);<span class='error_goto'> if (unlikely(!__pyx_tuple__48)) __PYX_ERR(0, 73, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__48);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__48);
  __pyx_codeobj__49 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(5, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__48, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_update_delta, 73, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__49)) __PYX_ERR(0, 73, __pyx_L1_error)</span>
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_CyFunction_NewEx</span>(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_5update_delta, 0, __pyx_n_s_SSDMetric_update_delta, NULL, __pyx_n_s_dipy_align_ssdmetric, __pyx_d, ((PyObject *)__pyx_codeobj__49));<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 73, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_c_api'>__Pyx_CyFunction_SetDefaultsTuple</span>(__pyx_t_3, __pyx_tuple__50);
  if (<span class='py_c_api'>PyObject_SetItem</span>(__pyx_t_2, __pyx_n_s_update_delta, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 73, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_tuple__50 = <span class='py_c_api'>PyTuple_Pack</span>(2, ((PyObject *)Py_None), ((PyObject *)Py_None));<span class='error_goto'> if (unlikely(!__pyx_tuple__50)) __PYX_ERR(0, 73, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__50);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__50);
</pre><pre class="cython line score-0">&#xA0;<span class="">074</span>:         <span class="s">r&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">075</span>: <span class="s">        Computes delta for static and moving points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">076</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">077</span>: <span class="s">        Parameters:</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">078</span>: <span class="s">        -----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">079</span>: <span class="s">        sval: array, shape (n, ) or (S, R, C) - intensities of static image either sampled or full image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">080</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">081</span>: <span class="s">        mval: array, shape (n,) or (S, R, C) - intensities of moving image  either sampled</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">082</span>: <span class="s">              of full image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">083</span>: <span class="s">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">084</span>:         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_called</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup_called);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 84, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_2 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 84, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = ((!__pyx_t_2) != 0);
  if (__pyx_t_3) {
/* … */
  }
</pre><pre class="cython line score-40" onclick='toggleDiv(this)'>+<span class="">085</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">sval</span><span class="p">,</span><span class="n">mval</span><span class="p">)</span></pre>
<pre class='cython code score-40 '>    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 85, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
    __pyx_t_5 = NULL;
    __pyx_t_6 = 0;
    if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_4))) {
      __pyx_t_5 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_4);
      if (likely(__pyx_t_5)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_4);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_5);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_4, function);
        __pyx_t_6 = 1;
      }
    }
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_4)) {
      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_v_sval, __pyx_v_mval};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_4, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 85, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_4)) {
      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_v_sval, __pyx_v_mval};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_4, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 85, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    } else
    #endif
    {
      __pyx_t_7 = <span class='py_c_api'>PyTuple_New</span>(2+__pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 85, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      if (__pyx_t_5) {
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
      }
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_sval);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_sval);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_7, 0+__pyx_t_6, __pyx_v_sval);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_mval);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_mval);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_7, 1+__pyx_t_6, __pyx_v_mval);
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_4, __pyx_t_7, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 85, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">086</span>: </pre>
<pre class="cython line score-8" onclick='toggleDiv(this)'>+<span class="">087</span>:         <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">sval</span> <span class="o">-</span> <span class="n">mval</span></pre>
<pre class='cython code score-8 '>  __pyx_t_1 = <span class='py_c_api'>PyNumber_Subtract</span>(__pyx_v_sval, __pyx_v_mval);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 87, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_delta, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 87, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">088</span>: </pre>
<pre class="cython line score-122" onclick='toggleDiv(this)'>+<span class="">089</span>:     <span class="k">def</span> <span class="nf">update_gradient_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="n">smask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mmask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-122 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_7update_gradient_dense(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_6update_gradient_dense[] = "\n        Compute the gradient with respect to transformation parameters.\n\n        The gradient is stored in - self.ssd_gradient.\n\n        Parameters\n        ----------\n        theta : array, shape (n,)\n            parameters to compute the gradient at\n        transform : instance of Transform\n            the transformation with respect to whose parameters the gradient\n            must be computed\n        static : array, shape (S, R, C)\n            static image\n        moving : array, shape (S, R, C)\n            moving image\n        grid2world : array, shape (4, 4)\n            we assume that both images have already been sampled at a common\n            grid. This transform must map voxel coordinates of this common grid\n            to physical coordinates of its corresponding voxel in the moving\n            image. For example, if the moving image was sampled on the static\n            image's grid (this is the typical setting) using an aligning\n            matrix A, then\n\n            (1) grid2world = A.dot(static_affine)\n\n            where static_affine is the transformation mapping static image's\n            grid coordinates to physical space.\n\n        mgradient : array, shape (S, R, C, 3)\n            the gradient of the moving image\n        smask : array, shape (S, R, C), optional\n            mask of static object being registered (a binary array with 1's\n            inside the object of interest and 0's along the background).\n            The default is None, indicating all voxels are considered.\n        mmask : array, shape (S, R, C), optional\n            mask of moving object being registered (a binary array with 1's\n            inside the object of interest and 0's along the background).\n            The default is None, indicating all voxels are considered.\n        ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_7update_gradient_dense = {"update_gradient_dense", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_7update_gradient_dense, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_6update_gradient_dense};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_7update_gradient_dense(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_self = 0;
  PyObject *__pyx_v_theta = 0;
  PyObject *__pyx_v_transform = 0;
  PyObject *__pyx_v_static = 0;
  PyObject *__pyx_v_moving = 0;
  PyObject *__pyx_v_grid2world = 0;
  PyObject *__pyx_v_mgradient = 0;
  PyObject *__pyx_v_smask = 0;
  PyObject *__pyx_v_mmask = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_gradient_dense (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_self,&amp;__pyx_n_s_theta,&amp;__pyx_n_s_transform,&amp;__pyx_n_s_static,&amp;__pyx_n_s_moving,&amp;__pyx_n_s_grid2world,&amp;__pyx_n_s_mgradient,&amp;__pyx_n_s_smask,&amp;__pyx_n_s_mmask,0};
    PyObject* values[9] = {0,0,0,0,0,0,0,0,0};
    values[7] = ((PyObject *)((PyObject *)Py_None));
    values[8] = ((PyObject *)((PyObject *)Py_None));
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  9: values[8] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 8);
        CYTHON_FALLTHROUGH;
        case  8: values[7] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 7);
        CYTHON_FALLTHROUGH;
        case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
        CYTHON_FALLTHROUGH;
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_theta)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 1); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_transform)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 2); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (likely((values[3] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_static)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 3); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (likely((values[4] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_moving)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 4); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  5:
        if (likely((values[5] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_grid2world)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 5); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  6:
        if (likely((values[6] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mgradient)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, 6); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  7:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_smask);
          if (value) { values[7] = value; kw_args--; }
        }
        CYTHON_FALLTHROUGH;
        case  8:
        if (kw_args &gt; 0) {
          PyObject* value = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mmask);
          if (value) { values[8] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "update_gradient_dense") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
      }
    } else {
      switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
        case  9: values[8] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 8);
        CYTHON_FALLTHROUGH;
        case  8: values[7] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 7);
        CYTHON_FALLTHROUGH;
        case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
        values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_self = values[0];
    __pyx_v_theta = values[1];
    __pyx_v_transform = values[2];
    __pyx_v_static = values[3];
    __pyx_v_moving = values[4];
    __pyx_v_grid2world = values[5];
    __pyx_v_mgradient = values[6];
    __pyx_v_smask = values[7];
    __pyx_v_mmask = values[8];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_dense", 0, 7, 9, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_gradient_dense", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_6update_gradient_dense(__pyx_self, __pyx_v_self, __pyx_v_theta, __pyx_v_transform, __pyx_v_static, __pyx_v_moving, __pyx_v_grid2world, __pyx_v_mgradient, __pyx_v_smask, __pyx_v_mmask);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_6update_gradient_dense(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_theta, PyObject *__pyx_v_transform, PyObject *__pyx_v_static, PyObject *__pyx_v_moving, PyObject *__pyx_v_grid2world, PyObject *__pyx_v_mgradient, PyObject *__pyx_v_smask, PyObject *__pyx_v_mmask) {
  PyObject *__pyx_v_dim = NULL;
  PyObject *__pyx_v_msg = NULL;
  PyObject *__pyx_v_n = NULL;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_gradient_dense", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_10);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_13, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_14, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_15, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_16, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_17, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_18, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_19, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_20, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_21, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_22, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_23, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_24, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_gradient_dense", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_dim);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_msg);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_n);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__51 = <span class='py_c_api'>PyTuple_Pack</span>(12, __pyx_n_s_self, __pyx_n_s_theta, __pyx_n_s_transform, __pyx_n_s_static, __pyx_n_s_moving, __pyx_n_s_grid2world, __pyx_n_s_mgradient, __pyx_n_s_smask, __pyx_n_s_mmask, __pyx_n_s_dim, __pyx_n_s_msg, __pyx_n_s_n);<span class='error_goto'> if (unlikely(!__pyx_tuple__51)) __PYX_ERR(0, 89, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__51);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__51);
  __pyx_codeobj__52 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(9, 0, 12, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__51, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_update_gradient_dense, 89, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__52)) __PYX_ERR(0, 89, __pyx_L1_error)</span>
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_CyFunction_NewEx</span>(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_7update_gradient_dense, 0, __pyx_n_s_SSDMetric_update_gradient_dense, NULL, __pyx_n_s_dipy_align_ssdmetric, __pyx_d, ((PyObject *)__pyx_codeobj__52));<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 89, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_c_api'>__Pyx_CyFunction_SetDefaultsTuple</span>(__pyx_t_3, __pyx_tuple__53);
  if (<span class='py_c_api'>PyObject_SetItem</span>(__pyx_t_2, __pyx_n_s_update_gradient_dense, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 89, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_tuple__53 = <span class='py_c_api'>PyTuple_Pack</span>(2, ((PyObject *)Py_None), ((PyObject *)Py_None));<span class='error_goto'> if (unlikely(!__pyx_tuple__53)) __PYX_ERR(0, 89, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__53);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__53);
</pre><pre class="cython line score-0">&#xA0;<span class="">090</span>:         <span class="s">r&quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">091</span>: <span class="s">        Compute the gradient with respect to transformation parameters.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">092</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">093</span>: <span class="s">        The gradient is stored in - self.ssd_gradient.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">094</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">095</span>: <span class="s">        Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">096</span>: <span class="s">        ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">097</span>: <span class="s">        theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">098</span>: <span class="s">            parameters to compute the gradient at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">099</span>: <span class="s">        transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">100</span>: <span class="s">            the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">101</span>: <span class="s">            must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">102</span>: <span class="s">        static : array, shape (S, R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">103</span>: <span class="s">            static image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">104</span>: <span class="s">        moving : array, shape (S, R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">105</span>: <span class="s">            moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">106</span>: <span class="s">        grid2world : array, shape (4, 4)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">107</span>: <span class="s">            we assume that both images have already been sampled at a common</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">108</span>: <span class="s">            grid. This transform must map voxel coordinates of this common grid</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">109</span>: <span class="s">            to physical coordinates of its corresponding voxel in the moving</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">110</span>: <span class="s">            image. For example, if the moving image was sampled on the static</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">111</span>: <span class="s">            image&#39;s grid (this is the typical setting) using an aligning</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">112</span>: <span class="s">            matrix A, then</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">113</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">114</span>: <span class="s">            (1) grid2world = A.dot(static_affine)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">115</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">116</span>: <span class="s">            where static_affine is the transformation mapping static image&#39;s</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">117</span>: <span class="s">            grid coordinates to physical space.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">118</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">119</span>: <span class="s">        mgradient : array, shape (S, R, C, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">120</span>: <span class="s">            the gradient of the moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">121</span>: <span class="s">        smask : array, shape (S, R, C), optional</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">122</span>: <span class="s">            mask of static object being registered (a binary array with 1&#39;s</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">123</span>: <span class="s">            inside the object of interest and 0&#39;s along the background).</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">124</span>: <span class="s">            The default is None, indicating all voxels are considered.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">125</span>: <span class="s">        mmask : array, shape (S, R, C), optional</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">126</span>: <span class="s">            mask of moving object being registered (a binary array with 1&#39;s</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">127</span>: <span class="s">            inside the object of interest and 0&#39;s along the background).</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">128</span>: <span class="s">            The default is None, indicating all voxels are considered.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">129</span>: <span class="s">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">130</span>: </pre>
<pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">131</span>:         <span class="k">if</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">moving</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span></pre>
<pre class='cython code score-14 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_static, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 131, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_moving, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 131, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_t_2, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 131, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_3); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 131, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (__pyx_t_4) {
/* … */
  }
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">132</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Images must have the same shape&quot;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple_, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_3, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='error_goto'>__PYX_ERR(0, 132, __pyx_L1_error)</span>
/* … */
  __pyx_tuple_ = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Images_must_have_the_same_shape);<span class='error_goto'> if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 132, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple_);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple_);
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">133</span>:         <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_static, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_5 = <span class='py_c_api'>PyObject_Length</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(0, 133, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='py_c_api'>PyInt_FromSsize_t</span>(__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 133, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_v_dim = __pyx_t_3;
  __pyx_t_3 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">134</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">135</span>: </pre>
<pre class="cython line score-18" onclick='toggleDiv(this)'>+<span class="">136</span>:         <span class="k">if</span> <span class="ow">not</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">2</span><span class="p">,</span> <span class="mf">3</span><span class="p">]:</span></pre>
<pre class='cython code score-18 '>  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dim);
  __pyx_t_3 = __pyx_v_dim;
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_3, __pyx_int_2, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 136, __pyx_L1_error)</span>
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 136, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_6) {
  } else {
    __pyx_t_4 = __pyx_t_6;
    goto __pyx_L5_bool_binop_done;
  }
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_3, __pyx_int_3, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 136, __pyx_L1_error)</span>
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 136, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = __pyx_t_6;
  __pyx_L5_bool_binop_done:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = (__pyx_t_4 != 0);
  if (__pyx_t_6) {
/* … */
  }
</pre><pre class="cython line score-6" onclick='toggleDiv(this)'>+<span class="">137</span>:             <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Only dimensions 2 and 3 are supported. &#39;</span> <span class="o">+</span>\</pre>
<pre class='cython code score-6 '>    __pyx_t_3 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_kp_s_Only_dimensions_2_and_3_are_supp, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 137, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-16" onclick='toggleDiv(this)'>+<span class="">138</span>:                 <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; received&#39;</span></pre>
<pre class='cython code score-16 '>    __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 138, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dim);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dim);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_v_dim);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(((PyObject *)(&amp;PyString_Type)), __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 138, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
/* … */
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_3, __pyx_kp_s_received);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 138, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_v_msg = __pyx_t_2;
    __pyx_t_2 = 0;
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">139</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 139, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_msg);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_msg);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_v_msg);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_t_2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 139, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_3, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='error_goto'>__PYX_ERR(0, 139, __pyx_L1_error)</span>
</pre><pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">140</span>:         <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_theta, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 140, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 140, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_n = __pyx_t_2;
  __pyx_t_2 = 0;
</pre><pre class="cython line score-28" onclick='toggleDiv(this)'>+<span class="">141</span>:         <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">moving</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">dim</span><span class="p">,):</span></pre>
<pre class='cython code score-28 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_moving, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dim);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dim);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_v_dim);
  __pyx_t_7 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_3, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_2, __pyx_t_7, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 141, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_6) {
/* … */
  }
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">142</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid gradient field dimensions.&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_1, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='error_goto'>__PYX_ERR(0, 142, __pyx_L1_error)</span>
/* … */
  __pyx_tuple__2 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Invalid_gradient_field_dimension);<span class='error_goto'> if (unlikely(!__pyx_tuple__2)) __PYX_ERR(0, 142, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__2);
</pre><pre class="cython line score-0">&#xA0;<span class="">143</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">144</span>:         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_called</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup_called);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 144, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_6 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 144, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_4 = ((!__pyx_t_6) != 0);
  if (__pyx_t_4) {
/* … */
  }
</pre><pre class="cython line score-44" onclick='toggleDiv(this)'>+<span class="">145</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span><span class="n">smask</span><span class="p">,</span><span class="n">mmask</span><span class="p">)</span></pre>
<pre class='cython code score-44 '>    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_setup);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 145, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    __pyx_t_2 = NULL;
    __pyx_t_8 = 0;
    if (CYTHON_UNPACK_METHODS &amp;&amp; likely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_7))) {
      __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_7);
      if (likely(__pyx_t_2)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_7);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_7, function);
        __pyx_t_8 = 1;
      }
    }
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[5] = {__pyx_t_2, __pyx_v_static, __pyx_v_moving, __pyx_v_smask, __pyx_v_mmask};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 4+__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 145, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_7)) {
      PyObject *__pyx_temp[5] = {__pyx_t_2, __pyx_v_static, __pyx_v_moving, __pyx_v_smask, __pyx_v_mmask};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 4+__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 145, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    } else
    #endif
    {
      __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(4+__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 145, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      if (__pyx_t_2) {
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
      }
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_static);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_static);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0+__pyx_t_8, __pyx_v_static);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_moving);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_moving);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1+__pyx_t_8, __pyx_v_moving);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_smask);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_smask);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 2+__pyx_t_8, __pyx_v_smask);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_mmask);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_mmask);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 3+__pyx_t_8, __pyx_v_mmask);
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_7, __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 145, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">146</span>: </pre>
<pre class="cython line score-20" onclick='toggleDiv(this)'>+<span class="">147</span>:         <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-20 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_6 = (__pyx_t_1 == Py_None);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_9 = (__pyx_t_6 != 0);
  if (!__pyx_t_9) {
  } else {
    __pyx_t_4 = __pyx_t_9;
    goto __pyx_L10_bool_binop_done;
  }
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_7, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_v_n, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_7);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_7); if (unlikely(__pyx_t_9 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 147, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_4 = __pyx_t_9;
  __pyx_L10_bool_binop_done:;
  if (__pyx_t_4) {
/* … */
  }
</pre><pre class="cython line score-54" onclick='toggleDiv(this)'>+<span class="">148</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span></pre>
<pre class='cython code score-54 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_n);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_n);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_v_n);
    __pyx_t_2 = NULL;
    if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
      __pyx_t_2 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
      if (likely(__pyx_t_2)) {
        PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
        <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
        <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    } else {
      #if CYTHON_FAST_PYCALL
      if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
        PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_1};
        __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      } else
      #endif
      #if CYTHON_FAST_PYCCALL
      if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
        PyObject *__pyx_temp[2] = {__pyx_t_2, __pyx_t_1};
        __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      } else
      #endif
      {
        __pyx_t_10 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 0, __pyx_t_2); __pyx_t_2 = NULL;
        <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
        <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 0+1, __pyx_t_1);
        __pyx_t_1 = 0;
        __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_10, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 148, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
      }
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient, __pyx_t_7) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 148, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">149</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">150</span>:         <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyInt_EqObjC</span>(__pyx_v_dim, __pyx_int_2, 2, 0);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 150, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_7); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 150, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
  if (__pyx_t_4) {
/* … */
    goto __pyx_L12;
  }
</pre><pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">151</span>:             <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 151, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 151, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 151, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_7, __pyx_t_10, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 151, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_3); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 151, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (__pyx_t_4) {
/* … */
      goto __pyx_L13;
    }
</pre><pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">152</span>:                 <span class="n">_gradient_dense_2d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="n">smask</span><span class="p">,</span><span class="n">mmask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_static);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_13 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_moving);
      if (unlikely(!__pyx_t_13.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_grid2world);
      if (unlikely(!__pyx_t_14.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_15 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_15.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_16 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_int</span>(__pyx_v_smask);
      if (unlikely(!__pyx_t_16.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_17 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_int</span>(__pyx_v_mmask);
      if (unlikely(!__pyx_t_17.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 152, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_3);
      if (unlikely(!__pyx_t_18.memview)) <span class='error_goto'>__PYX_ERR(0, 152, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_2d(__pyx_t_11, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_12, __pyx_t_13, __pyx_t_14, __pyx_t_15, __pyx_t_16, __pyx_t_17, __pyx_t_18);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 152, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_13, 1);
      __pyx_t_13.memview = NULL;
      __pyx_t_13.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_14, 1);
      __pyx_t_14.memview = NULL;
      __pyx_t_14.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_15, 1);
      __pyx_t_15.memview = NULL;
      __pyx_t_15.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_16, 1);
      __pyx_t_16.memview = NULL;
      __pyx_t_16.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_17, 1);
      __pyx_t_17.memview = NULL;
      __pyx_t_17.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_18, 1);
      __pyx_t_18.memview = NULL;
      __pyx_t_18.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">153</span>: </pre>
<pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">154</span>:             <span class="k">elif</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_10, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_t_10 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_3, __pyx_t_7, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_10);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_10); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 154, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    if (__pyx_t_4) {
/* … */
      goto __pyx_L13;
    }
</pre><pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">155</span>:                 <span class="n">_gradient_dense_2d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="n">smask</span><span class="p">,</span> <span class="n">mmask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_18.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_14 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_static);
      if (unlikely(!__pyx_t_14.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_13 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_moving);
      if (unlikely(!__pyx_t_13.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_grid2world);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_19 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_float</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_19.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_17 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_int</span>(__pyx_v_smask);
      if (unlikely(!__pyx_t_17.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_16 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_int</span>(__pyx_v_mmask);
      if (unlikely(!__pyx_t_16.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 155, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_10);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 155, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = __pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_2d(__pyx_t_18, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_14, __pyx_t_13, __pyx_t_12, __pyx_t_19, __pyx_t_17, __pyx_t_16, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 155, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_18, 1);
      __pyx_t_18.memview = NULL;
      __pyx_t_18.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_14, 1);
      __pyx_t_14.memview = NULL;
      __pyx_t_14.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_13, 1);
      __pyx_t_13.memview = NULL;
      __pyx_t_13.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_19, 1);
      __pyx_t_19.memview = NULL;
      __pyx_t_19.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_17, 1);
      __pyx_t_17.memview = NULL;
      __pyx_t_17.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_16, 1);
      __pyx_t_16.memview = NULL;
      __pyx_t_16.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">156</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">157</span>:             <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">158</span>:                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Grad field dtype must be floating point&quot;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    /*else*/ {
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
      <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_10, 0, 0, 0);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
      <span class='error_goto'>__PYX_ERR(0, 158, __pyx_L1_error)</span>
    }
    __pyx_L13:;
/* … */
  __pyx_tuple__3 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Grad_field_dtype_must_be_floatin);<span class='error_goto'> if (unlikely(!__pyx_tuple__3)) __PYX_ERR(0, 158, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__3);
</pre><pre class="cython line score-0">&#xA0;<span class="">159</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">160</span>:         <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyInt_EqObjC</span>(__pyx_v_dim, __pyx_int_3, 3, 0);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 160, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_10); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 160, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
  if (__pyx_t_4) {
/* … */
    goto __pyx_L12;
  }
</pre><pre class="cython line score-2" onclick='toggleDiv(this)'>+<span class="">161</span>:             <span class="k">print</span><span class="p">(</span><span class="s">&quot;gradin&quot;</span><span class="p">)</span></pre>
<pre class='cython code score-2 '>    if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_n_s_gradin) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 161, __pyx_L1_error)</span>
</pre><pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">162</span>:             <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_7, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_10, __pyx_t_3, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_7);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 162, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_7); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 162, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    if (__pyx_t_4) {
/* … */
      goto __pyx_L14;
    }
</pre><pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">163</span>:                 <span class="n">_gradient_dense_3d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="n">smask</span><span class="p">,</span> <span class="n">mmask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_15 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(__pyx_v_static);
      if (unlikely(!__pyx_t_15.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_20 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(__pyx_v_moving);
      if (unlikely(!__pyx_t_20.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_grid2world);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_21 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsdsds_double</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_21.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_22 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_int</span>(__pyx_v_smask);
      if (unlikely(!__pyx_t_22.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_23 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_int</span>(__pyx_v_mmask);
      if (unlikely(!__pyx_t_23.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_7);
      if (unlikely(!__pyx_t_18.memview)) <span class='error_goto'>__PYX_ERR(0, 163, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_7 = __pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_3d(__pyx_t_11, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_15, __pyx_t_20, __pyx_t_12, __pyx_t_21, __pyx_t_22, __pyx_t_23, __pyx_t_18);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 163, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_15, 1);
      __pyx_t_15.memview = NULL;
      __pyx_t_15.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_20, 1);
      __pyx_t_20.memview = NULL;
      __pyx_t_20.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_21, 1);
      __pyx_t_21.memview = NULL;
      __pyx_t_21.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_22, 1);
      __pyx_t_22.memview = NULL;
      __pyx_t_22.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_23, 1);
      __pyx_t_23.memview = NULL;
      __pyx_t_23.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_18, 1);
      __pyx_t_18.memview = NULL;
      __pyx_t_18.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">164</span>: </pre>
<pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">165</span>:             <span class="k">elif</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 165, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_7);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 165, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 165, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_7, __pyx_t_10, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 165, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_3); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 165, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (__pyx_t_4) {
/* … */
    }
    __pyx_L14:;
</pre><pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">166</span>:                 <span class="n">_gradient_dense_3d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="n">smask</span><span class="p">,</span> <span class="n">mmask</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>      __pyx_t_18 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_18.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_20 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(__pyx_v_static);
      if (unlikely(!__pyx_t_20.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_15 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(__pyx_v_moving);
      if (unlikely(!__pyx_t_15.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_grid2world);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_24 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsdsds_float</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_24.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_23 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_int</span>(__pyx_v_smask);
      if (unlikely(!__pyx_t_23.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_22 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_int</span>(__pyx_v_mmask);
      if (unlikely(!__pyx_t_22.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 166, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_3);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 166, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_3d(__pyx_t_18, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_20, __pyx_t_15, __pyx_t_12, __pyx_t_24, __pyx_t_23, __pyx_t_22, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 166, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_18, 1);
      __pyx_t_18.memview = NULL;
      __pyx_t_18.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_20, 1);
      __pyx_t_20.memview = NULL;
      __pyx_t_20.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_15, 1);
      __pyx_t_15.memview = NULL;
      __pyx_t_15.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_24, 1);
      __pyx_t_24.memview = NULL;
      __pyx_t_24.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_23, 1);
      __pyx_t_23.memview = NULL;
      __pyx_t_23.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_22, 1);
      __pyx_t_22.memview = NULL;
      __pyx_t_22.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">167</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">168</span>:         <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">169</span>:             <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Only dimensions 2 and 3 are supported. &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">+</span>\</pre>
<pre class='cython code score-22 '>  /*else*/ {
    __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dim);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dim);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_v_dim);
    __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(((PyObject *)(&amp;PyString_Type)), __pyx_t_3, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_kp_s_Only_dimensions_2_and_3_are_supp, __pyx_t_10);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_t_10 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_3, __pyx_kp_s_received);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 169, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_v_msg = __pyx_t_10;
    __pyx_t_10 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">170</span>:                 <span class="s">&#39; received&#39;</span></pre>
<pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">171</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>    __pyx_t_10 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 171, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_10);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_msg);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_msg);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 0, __pyx_v_msg);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_t_10, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 171, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_10); __pyx_t_10 = 0;
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_3, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='error_goto'>__PYX_ERR(0, 171, __pyx_L1_error)</span>
  }
  __pyx_L12:;
</pre><pre class="cython line score-0">&#xA0;<span class="">172</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">173</span>: </pre>
<pre class="cython line score-100" onclick='toggleDiv(this)'>+<span class="">174</span>:     <span class="k">def</span> <span class="nf">update_gradient_sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">):</span></pre>
<pre class='cython code score-100 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_9update_gradient_sparse(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_8update_gradient_sparse[] = " Computes the Gradient of the  w.r.t. transform parameters\n\n       \n        The gradient is stored in self.ssd_gradient.\n\n        Parameters\n        ----------\n        theta : array, shape (n,)\n            parameters to compute the gradient at\n        transform : instance of Transform\n            the transformation with respect to whose parameters the gradient\n            must be computed\n        sval : array, shape (m,)\n            sampled intensities from the static image at sampled_points\n        mval : array, shape (m,)\n            sampled intensities from the moving image at sampled_points\n        sample_points : array, shape (m, 3)\n            coordinates (in physical space) of the points the images were\n            sampled at\n        mgradient : array, shape (m, 3)\n            the gradient of the moving image at the sample points\n        ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_9update_gradient_sparse = {"update_gradient_sparse", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_9update_gradient_sparse, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_9SSDMetric_8update_gradient_sparse};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_9SSDMetric_9update_gradient_sparse(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_self = 0;
  PyObject *__pyx_v_theta = 0;
  PyObject *__pyx_v_transform = 0;
  PyObject *__pyx_v_sval = 0;
  PyObject *__pyx_v_mval = 0;
  PyObject *__pyx_v_sample_points = 0;
  PyObject *__pyx_v_mgradient = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_gradient_sparse (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_self,&amp;__pyx_n_s_theta,&amp;__pyx_n_s_transform,&amp;__pyx_n_s_sval,&amp;__pyx_n_s_mval,&amp;__pyx_n_s_sample_points,&amp;__pyx_n_s_mgradient,0};
    PyObject* values[7] = {0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
        CYTHON_FALLTHROUGH;
        case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
        CYTHON_FALLTHROUGH;
        case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
        CYTHON_FALLTHROUGH;
        case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
        CYTHON_FALLTHROUGH;
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_theta)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 1); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_transform)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 2); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  3:
        if (likely((values[3] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_sval)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 3); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  4:
        if (likely((values[4] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mval)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 4); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  5:
        if (likely((values[5] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_sample_points)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 5); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  6:
        if (likely((values[6] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mgradient)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, 6); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "update_gradient_sparse") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
      }
    } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 7) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
      values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
      values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
      values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
      values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
    }
    __pyx_v_self = values[0];
    __pyx_v_theta = values[1];
    __pyx_v_transform = values[2];
    __pyx_v_sval = values[3];
    __pyx_v_mval = values[4];
    __pyx_v_sample_points = values[5];
    __pyx_v_mgradient = values[6];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("update_gradient_sparse", 1, 7, 7, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_gradient_sparse", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_8update_gradient_sparse(__pyx_self, __pyx_v_self, __pyx_v_theta, __pyx_v_transform, __pyx_v_sval, __pyx_v_mval, __pyx_v_sample_points, __pyx_v_mgradient);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_9SSDMetric_8update_gradient_sparse(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_theta, PyObject *__pyx_v_transform, PyObject *__pyx_v_sval, PyObject *__pyx_v_mval, PyObject *__pyx_v_sample_points, PyObject *__pyx_v_mgradient) {
  PyObject *__pyx_v_dim = NULL;
  PyObject *__pyx_v_nsamples = NULL;
  PyObject *__pyx_v_n = NULL;
  PyObject *__pyx_v_msg = NULL;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("update_gradient_sparse", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.SSDMetric.update_gradient_sparse", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_dim);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_nsamples);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_n);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_msg);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__54 = <span class='py_c_api'>PyTuple_Pack</span>(11, __pyx_n_s_self, __pyx_n_s_theta, __pyx_n_s_transform, __pyx_n_s_sval, __pyx_n_s_mval, __pyx_n_s_sample_points, __pyx_n_s_mgradient, __pyx_n_s_dim, __pyx_n_s_nsamples, __pyx_n_s_n, __pyx_n_s_msg);<span class='error_goto'> if (unlikely(!__pyx_tuple__54)) __PYX_ERR(0, 174, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__54);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__54);
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_CyFunction_NewEx</span>(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_9SSDMetric_9update_gradient_sparse, 0, __pyx_n_s_SSDMetric_update_gradient_sparse, NULL, __pyx_n_s_dipy_align_ssdmetric, __pyx_d, ((PyObject *)__pyx_codeobj__55));<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 174, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyObject_SetItem</span>(__pyx_t_2, __pyx_n_s_update_gradient_sparse, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 174, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_codeobj__55 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(7, 0, 11, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__54, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_update_gradient_sparse, 174, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__55)) __PYX_ERR(0, 174, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">175</span>:         <span class="s">r&quot;&quot;&quot; Computes the Gradient of the  w.r.t. transform parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">176</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">177</span>: <span class="s">       </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">178</span>: <span class="s">        The gradient is stored in self.ssd_gradient.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">179</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">180</span>: <span class="s">        Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">181</span>: <span class="s">        ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">182</span>: <span class="s">        theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">183</span>: <span class="s">            parameters to compute the gradient at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">184</span>: <span class="s">        transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">185</span>: <span class="s">            the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">186</span>: <span class="s">            must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">187</span>: <span class="s">        sval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">188</span>: <span class="s">            sampled intensities from the static image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">189</span>: <span class="s">        mval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">190</span>: <span class="s">            sampled intensities from the moving image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">191</span>: <span class="s">        sample_points : array, shape (m, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">192</span>: <span class="s">            coordinates (in physical space) of the points the images were</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">193</span>: <span class="s">            sampled at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">194</span>: <span class="s">        mgradient : array, shape (m, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">195</span>: <span class="s">            the gradient of the moving image at the sample points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">196</span>: <span class="s">        &quot;&quot;&quot;</span></pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">197</span>:         <span class="n">dim</span> <span class="o">=</span> <span class="n">sample_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_sample_points, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 197, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 197, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_dim = __pyx_t_2;
  __pyx_t_2 = 0;
</pre><pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">198</span>:         <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim</span><span class="p">:</span></pre>
<pre class='cython code score-14 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 198, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_2, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 198, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_v_dim, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 198, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 198, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_3) {
/* … */
  }
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">199</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Dimensions of gradients and points are different&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__4, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 199, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_2, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='error_goto'>__PYX_ERR(0, 199, __pyx_L1_error)</span>
/* … */
  __pyx_tuple__4 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Dimensions_of_gradients_and_poin);<span class='error_goto'> if (unlikely(!__pyx_tuple__4)) __PYX_ERR(0, 199, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__4);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__4);
</pre><pre class="cython line score-0">&#xA0;<span class="">200</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">201</span>:         <span class="n">nsamples</span> <span class="o">=</span> <span class="n">sval</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_sval, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 201, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 201, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_nsamples = __pyx_t_1;
  __pyx_t_1 = 0;
</pre><pre class="cython line score-28" onclick='toggleDiv(this)'>+<span class="">202</span>:         <span class="k">if</span> <span class="p">((</span><span class="n">mgradient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nsamples</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mval</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nsamples</span><span class="p">)</span></pre>
<pre class='cython code score-28 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_2, __pyx_v_nsamples, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (!__pyx_t_4) {
  } else {
    __pyx_t_3 = __pyx_t_4;
    goto __pyx_L5_bool_binop_done;
  }
/* … */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mval, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
/* … */
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_2, __pyx_v_nsamples, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 202, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (!__pyx_t_4) {
  } else {
    __pyx_t_3 = __pyx_t_4;
    goto __pyx_L5_bool_binop_done;
  }
/* … */
  if (__pyx_t_3) {
/* … */
  }
</pre><pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">203</span>:             <span class="ow">or</span> <span class="n">sample_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nsamples</span><span class="p">):</span></pre>
<pre class='cython code score-14 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_sample_points, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 203, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 203, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_2, __pyx_v_nsamples, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 203, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 203, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __pyx_t_4;
  __pyx_L5_bool_binop_done:;
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">204</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Number of points and gradients are different.&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 204, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_1, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='error_goto'>__PYX_ERR(0, 204, __pyx_L1_error)</span>
/* … */
  __pyx_tuple__5 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Number_of_points_and_gradients_a);<span class='error_goto'> if (unlikely(!__pyx_tuple__5)) __PYX_ERR(0, 204, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__5);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__5);
</pre><pre class="cython line score-0">&#xA0;<span class="">205</span>: </pre>
<pre class="cython line score-31" onclick='toggleDiv(this)'>+<span class="">206</span>:         <span class="k">if</span> <span class="ow">not</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span></pre>
<pre class='cython code score-31 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_t_5, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_4) {
  } else {
    __pyx_t_3 = __pyx_t_4;
    goto __pyx_L9_bool_binop_done;
  }
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_t_5, Py_NE); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_4 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 206, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_3 = __pyx_t_4;
  __pyx_L9_bool_binop_done:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_4 = (__pyx_t_3 != 0);
  if (__pyx_t_4) {
/* … */
  }
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">207</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Gradients dtype must be floating point&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__6, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 207, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_1, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='error_goto'>__PYX_ERR(0, 207, __pyx_L1_error)</span>
/* … */
  __pyx_tuple__6 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Gradients_dtype_must_be_floating);<span class='error_goto'> if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 207, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__6);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__6);
</pre><pre class="cython line score-0">&#xA0;<span class="">208</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">209</span>:         <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_theta, __pyx_n_s_shape);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 209, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 209, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_n = __pyx_t_2;
  __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">210</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">211</span>: </pre>
<pre class="cython line score-3" onclick='toggleDiv(this)'>+<span class="">212</span>:         <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span></pre>
<pre class='cython code score-3 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 212, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = (__pyx_t_2 == Py_None);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_3 = (__pyx_t_4 != 0);
  if (__pyx_t_3) {
/* … */
  }
</pre><pre class="cython line score-27" onclick='toggleDiv(this)'>+<span class="">213</span>:             <span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span></pre>
<pre class='cython code score-27 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_zeros);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_n);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_n);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_v_n);
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_2, __pyx_n_s_shape, __pyx_t_5) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_empty_tuple, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    if (<span class='pyx_c_api'>__Pyx_PyObject_SetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient, __pyx_t_5) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 213, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">214</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">215</span>:         <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mf">2</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyInt_EqObjC</span>(__pyx_v_dim, __pyx_int_2, 2, 0);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 215, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_5); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 215, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  if (__pyx_t_3) {
/* … */
    goto __pyx_L12;
  }
</pre><pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">216</span>:             <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_5, __pyx_t_1, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 216, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 216, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    if (__pyx_t_3) {
/* … */
      goto __pyx_L13;
    }
</pre><pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">217</span>:                 <span class="n">_gradient_sparse_2d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 217, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 217, __pyx_L1_error)</span>
/* … */
      __pyx_t_2 = __pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_2d(__pyx_t_6, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_7, __pyx_t_8, __pyx_t_9, __pyx_t_10, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 217, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
      __pyx_t_6.memview = NULL;
      __pyx_t_6.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
      __pyx_t_7.memview = NULL;
      __pyx_t_7.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
      __pyx_t_8.memview = NULL;
      __pyx_t_8.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
      __pyx_t_9.memview = NULL;
      __pyx_t_9.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
      __pyx_t_10.memview = NULL;
      __pyx_t_10.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">218</span>:                     <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_sval);
      if (unlikely(!__pyx_t_7.memview)) <span class='error_goto'>__PYX_ERR(0, 218, __pyx_L1_error)</span>
      __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_mval);
      if (unlikely(!__pyx_t_8.memview)) <span class='error_goto'>__PYX_ERR(0, 218, __pyx_L1_error)</span>
      __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_sample_points);
      if (unlikely(!__pyx_t_9.memview)) <span class='error_goto'>__PYX_ERR(0, 218, __pyx_L1_error)</span>
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_10.memview)) <span class='error_goto'>__PYX_ERR(0, 218, __pyx_L1_error)</span>
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 218, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_2);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 218, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">219</span>:             <span class="k">elif</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 219, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 219, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 219, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_2, __pyx_t_5, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 219, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 219, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    if (__pyx_t_3) {
/* … */
      goto __pyx_L13;
    }
</pre><pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">220</span>:                 <span class="n">_gradient_sparse_2d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 220, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 220, __pyx_L1_error)</span>
/* … */
      __pyx_t_1 = __pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_2d(__pyx_t_11, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_8, __pyx_t_7, __pyx_t_10, __pyx_t_12, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 220, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
      __pyx_t_8.memview = NULL;
      __pyx_t_8.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
      __pyx_t_7.memview = NULL;
      __pyx_t_7.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
      __pyx_t_10.memview = NULL;
      __pyx_t_10.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
      __pyx_t_6.memview = NULL;
      __pyx_t_6.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">221</span>:                     <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>      __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_sval);
      if (unlikely(!__pyx_t_8.memview)) <span class='error_goto'>__PYX_ERR(0, 221, __pyx_L1_error)</span>
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_mval);
      if (unlikely(!__pyx_t_7.memview)) <span class='error_goto'>__PYX_ERR(0, 221, __pyx_L1_error)</span>
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_sample_points);
      if (unlikely(!__pyx_t_10.memview)) <span class='error_goto'>__PYX_ERR(0, 221, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_float</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 221, __pyx_L1_error)</span>
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 221, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_1);
      if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 221, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">222</span>:             <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">223</span>:                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Gradients dtype must be floating point&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    /*else*/ {
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__7, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_1, 0, 0, 0);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
      <span class='error_goto'>__PYX_ERR(0, 223, __pyx_L1_error)</span>
    }
    __pyx_L13:;
/* … */
  __pyx_tuple__7 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Gradients_dtype_must_be_floating);<span class='error_goto'> if (unlikely(!__pyx_tuple__7)) __PYX_ERR(0, 223, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__7);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__7);
</pre><pre class="cython line score-0">&#xA0;<span class="">224</span>: </pre>
<pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">225</span>:         <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mf">3</span><span class="p">:</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyInt_EqObjC</span>(__pyx_v_dim, __pyx_int_3, 3, 0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 225, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_1); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 225, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_3) {
/* … */
    goto __pyx_L12;
  }
</pre><pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">226</span>:             <span class="k">if</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 226, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 226, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 226, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_1, __pyx_t_2, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 226, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_5); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 226, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    if (__pyx_t_3) {
/* … */
      goto __pyx_L14;
    }
</pre><pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">227</span>:                 <span class="n">_gradient_sparse_3d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">double</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 227, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 227, __pyx_L1_error)</span>
/* … */
      __pyx_t_5 = __pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_3d(__pyx_t_6, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_7, __pyx_t_8, __pyx_t_10, __pyx_t_9, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 227, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
      __pyx_t_6.memview = NULL;
      __pyx_t_6.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
      __pyx_t_7.memview = NULL;
      __pyx_t_7.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
      __pyx_t_8.memview = NULL;
      __pyx_t_8.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_10, 1);
      __pyx_t_10.memview = NULL;
      __pyx_t_10.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
      __pyx_t_9.memview = NULL;
      __pyx_t_9.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">228</span>:                     <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_sval);
      if (unlikely(!__pyx_t_7.memview)) <span class='error_goto'>__PYX_ERR(0, 228, __pyx_L1_error)</span>
      __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_mval);
      if (unlikely(!__pyx_t_8.memview)) <span class='error_goto'>__PYX_ERR(0, 228, __pyx_L1_error)</span>
      __pyx_t_10 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_sample_points);
      if (unlikely(!__pyx_t_10.memview)) <span class='error_goto'>__PYX_ERR(0, 228, __pyx_L1_error)</span>
      __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_9.memview)) <span class='error_goto'>__PYX_ERR(0, 228, __pyx_L1_error)</span>
      __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 228, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_5);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 228, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">229</span>: </pre>
<pre class="cython line score-17" onclick='toggleDiv(this)'>+<span class="">230</span>:             <span class="k">elif</span> <span class="n">mgradient</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span></pre>
<pre class='cython code score-17 '>    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_mgradient, __pyx_n_s_dtype);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 230, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 230, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float32);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 230, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_t_5, __pyx_t_1, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 230, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_2); if (unlikely(__pyx_t_3 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 230, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    if (__pyx_t_3) {
/* … */
      goto __pyx_L14;
    }
</pre><pre class="cython line score-5" onclick='toggleDiv(this)'>+<span class="">231</span>:                 <span class="n">_gradient_sparse_3d</span><span class="p">[</span><span class="n">cython</span><span class="o">.</span><span class="n">float</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-5 '>      __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_theta);
      if (unlikely(!__pyx_t_11.memview)) <span class='error_goto'>__PYX_ERR(0, 231, __pyx_L1_error)</span>
      if (!(likely(((__pyx_v_transform) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_v_transform, __pyx_ptype_4dipy_5align_10transforms_Transform))))) <span class='error_goto'>__PYX_ERR(0, 231, __pyx_L1_error)</span>
/* … */
      __pyx_t_2 = __pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_3d(__pyx_t_11, ((struct __pyx_obj_4dipy_5align_10transforms_Transform *)__pyx_v_transform), __pyx_t_8, __pyx_t_7, __pyx_t_9, __pyx_t_12, __pyx_t_6);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 231, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_11, 1);
      __pyx_t_11.memview = NULL;
      __pyx_t_11.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_8, 1);
      __pyx_t_8.memview = NULL;
      __pyx_t_8.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_7, 1);
      __pyx_t_7.memview = NULL;
      __pyx_t_7.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
      __pyx_t_9.memview = NULL;
      __pyx_t_9.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_12, 1);
      __pyx_t_12.memview = NULL;
      __pyx_t_12.data = NULL;
      __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
      __pyx_t_6.memview = NULL;
      __pyx_t_6.data = NULL;
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">232</span>:                     <span class="n">sval</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">mgradient</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ssd_gradient</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>      __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_sval);
      if (unlikely(!__pyx_t_8.memview)) <span class='error_goto'>__PYX_ERR(0, 232, __pyx_L1_error)</span>
      __pyx_t_7 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_v_mval);
      if (unlikely(!__pyx_t_7.memview)) <span class='error_goto'>__PYX_ERR(0, 232, __pyx_L1_error)</span>
      __pyx_t_9 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_v_sample_points);
      if (unlikely(!__pyx_t_9.memview)) <span class='error_goto'>__PYX_ERR(0, 232, __pyx_L1_error)</span>
      __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_float</span>(__pyx_v_mgradient);
      if (unlikely(!__pyx_t_12.memview)) <span class='error_goto'>__PYX_ERR(0, 232, __pyx_L1_error)</span>
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_v_self, __pyx_n_s_ssd_gradient);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 232, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_2);
      if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 232, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">233</span>:             <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">234</span>:                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Gradients dtype must be floating point&#39;</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>    /*else*/ {
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_tuple__8, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 234, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_2, 0, 0, 0);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
      <span class='error_goto'>__PYX_ERR(0, 234, __pyx_L1_error)</span>
    }
    __pyx_L14:;
/* … */
  __pyx_tuple__8 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_kp_s_Gradients_dtype_must_be_floating);<span class='error_goto'> if (unlikely(!__pyx_tuple__8)) __PYX_ERR(0, 234, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__8);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__8);
</pre><pre class="cython line score-0">&#xA0;<span class="">235</span>:         <span class="k">else</span><span class="p">:</span></pre>
<pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">236</span>:             <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Only dimensions 2 and 3 are supported. &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">+</span>\</pre>
<pre class='cython code score-22 '>  /*else*/ {
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 236, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_dim);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_dim);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_v_dim);
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(((PyObject *)(&amp;PyString_Type)), __pyx_t_2, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 236, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_kp_s_Only_dimensions_2_and_3_are_supp, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 236, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_2, __pyx_kp_s_received);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 236, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_v_msg = __pyx_t_1;
    __pyx_t_1 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">237</span>:                 <span class="s">&#39; received&#39;</span></pre>
<pre class="cython line score-13" onclick='toggleDiv(this)'>+<span class="">238</span>:             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre>
<pre class='cython code score-13 '>    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 238, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_msg);
    <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_v_msg);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_v_msg);
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_builtin_ValueError, __pyx_t_1, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 238, __pyx_L1_error)</span>
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_c_api'>__Pyx_Raise</span>(__pyx_t_2, 0, 0, 0);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='error_goto'>__PYX_ERR(0, 238, __pyx_L1_error)</span>
  }
  __pyx_L12:;
</pre><pre class="cython line score-0">&#xA0;<span class="">239</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">240</span>: </pre>
<pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">241</span>: <span class="k">cdef</span> <span class="nf">_gradient_dense_2d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">theta</span><span class="p">,</span> <span class="n">Transform</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-14 '>static PyObject *__pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_2d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_static, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_moving, __Pyx_memviewslice __pyx_v_grid2world, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_smask, __Pyx_memviewslice __pyx_v_mmask, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_valid_points;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_k;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_x = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_0_gradient_dense_2d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_dense_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_x, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_2d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_static, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_moving, __Pyx_memviewslice __pyx_v_grid2world, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_smask, __Pyx_memviewslice __pyx_v_mmask, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_valid_points;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_k;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_x = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_1_gradient_dense_2d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_dense_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_x, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">242</span>:                                   <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">static</span><span class="p">,</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">moving</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">243</span>:                                   <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">grid2world</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">244</span>:                                   <span class="n">floating</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">mgradient</span><span class="p">,</span>  <span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">smask</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">245</span>:                                   <span class="nb">int</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">mmask</span><span class="p">,</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">grad</span><span class="p">):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">246</span>:     <span class="s">r&quot;&quot;&quot; Gradient of the metric w.r.t. transform parameters theta</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">247</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">248</span>: <span class="s">    Computes the vector of partial derivatives </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">249</span>: <span class="s">    each transformation parameter. The transformation itself is not necessary</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">250</span>: <span class="s">    to compute the gradient, but only its Jacobian.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">251</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">252</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">253</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">254</span>: <span class="s">    theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">255</span>: <span class="s">        parameters of the transformation to compute the gradient from</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">256</span>: <span class="s">    transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">257</span>: <span class="s">        the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">258</span>: <span class="s">        must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">259</span>: <span class="s">    static : array, shape (R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">260</span>: <span class="s">        static image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">261</span>: <span class="s">    moving : array, shape (R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">262</span>: <span class="s">        moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">263</span>: <span class="s">    grid2world : array, shape (3, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">264</span>: <span class="s">        the grid-to-space transform associated with images static and moving</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">265</span>: <span class="s">        (we assume that both images have already been sampled at a common grid)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">266</span>: <span class="s">    mgradient : array, shape (R, C, 2)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">267</span>: <span class="s">        the gradient of the moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">268</span>: <span class="s">    </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">269</span>: <span class="s">    grad : array, shape (len(theta))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">270</span>: <span class="s">        the array to write the gradient to</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">271</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">272</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">273</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nrows</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nrows = (__pyx_v_static.shape[0]);
/* … */
  __pyx_v_nrows = (__pyx_v_static.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">274</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_ncols = (__pyx_v_static.shape[1]);
/* … */
  __pyx_v_ncols = (__pyx_v_static.shape[1]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">275</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_theta.shape[0]);
/* … */
  __pyx_v_n = (__pyx_v_theta.shape[0]);
</pre><pre class="cython line score-0">&#xA0;<span class="">276</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">offset</span><span class="p">,</span> <span class="n">valid_points</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">277</span>:         <span class="nb">int</span> <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_constant_jacobian = 0;
/* … */
  __pyx_v_constant_jacobian = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">278</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">279</span>:         <span class="n">double</span> <span class="n">rn</span><span class="p">,</span> <span class="n">cn</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">280</span>:         <span class="n">double</span> <span class="n">val</span><span class="p">,</span> <span class="n">spline_arg</span><span class="p">,</span> <span class="n">norm_factor</span></pre>
<pre class="cython line score-82" onclick='toggleDiv(this)'>+<span class="">281</span>:         <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-82 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
/* … */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 281, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
</pre><pre class="cython line score-70" onclick='toggleDiv(this)'>+<span class="">282</span>:         <span class="n">double</span><span class="p">[:]</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">2</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-70 '>  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_shape, __pyx_tuple__9) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_4);
  if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_x = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
/* … */
  __pyx_tuple__9 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_int_2);<span class='error_goto'> if (unlikely(!__pyx_tuple__9)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__9);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__9);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_shape, __pyx_tuple__10) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_4);
  if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_x = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
  __pyx_tuple__10 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_int_2);<span class='error_goto'> if (unlikely(!__pyx_tuple__10)) __PYX_ERR(0, 282, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__10);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__10);
</pre><pre class="cython line score-0">&#xA0;<span class="">283</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">284</span>:     <span class="n">grad</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
/* … */
  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
</pre><pre class="cython line score-8" onclick='toggleDiv(this)'>+<span class="">285</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-8 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
/* … */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">286</span>:         <span class="n">valid_points</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_valid_points = 0;
/* … */
        __pyx_v_valid_points = 0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">287</span>:         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_7 = __pyx_v_nrows;
        for (__pyx_t_8 = 0; __pyx_t_8 &lt; __pyx_t_7; __pyx_t_8+=1) {
          __pyx_v_i = __pyx_t_8;
/* … */
        __pyx_t_7 = __pyx_v_nrows;
        for (__pyx_t_8 = 0; __pyx_t_8 &lt; __pyx_t_7; __pyx_t_8+=1) {
          __pyx_v_i = __pyx_t_8;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">288</span>:             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_9 = __pyx_v_ncols;
          for (__pyx_t_10 = 0; __pyx_t_10 &lt; __pyx_t_9; __pyx_t_10+=1) {
            __pyx_v_j = __pyx_t_10;
/* … */
          __pyx_t_9 = __pyx_v_ncols;
          for (__pyx_t_10 = 0; __pyx_t_10 &lt; __pyx_t_9; __pyx_t_10+=1) {
            __pyx_v_j = __pyx_t_10;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">289</span>:                 <span class="k">if</span> <span class="n">smask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">smask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>            __pyx_t_12 = ((((PyObject *) __pyx_v_smask.memview) != Py_None) != 0);
            if (__pyx_t_12) {
            } else {
              __pyx_t_11 = __pyx_t_12;
              goto __pyx_L11_bool_binop_done;
            }
            __pyx_t_13 = __pyx_v_i;
            __pyx_t_14 = __pyx_v_j;
            __pyx_t_12 = (((*((int *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_smask.data + __pyx_t_13 * __pyx_v_smask.strides[0]) ) + __pyx_t_14 * __pyx_v_smask.strides[1]) ))) == 0) != 0);
            __pyx_t_11 = __pyx_t_12;
            __pyx_L11_bool_binop_done:;
            if (__pyx_t_11) {
/* … */
            }
/* … */
            __pyx_t_12 = ((((PyObject *) __pyx_v_smask.memview) != Py_None) != 0);
            if (__pyx_t_12) {
            } else {
              __pyx_t_11 = __pyx_t_12;
              goto __pyx_L11_bool_binop_done;
            }
            __pyx_t_13 = __pyx_v_i;
            __pyx_t_14 = __pyx_v_j;
            __pyx_t_12 = (((*((int *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_smask.data + __pyx_t_13 * __pyx_v_smask.strides[0]) ) + __pyx_t_14 * __pyx_v_smask.strides[1]) ))) == 0) != 0);
            __pyx_t_11 = __pyx_t_12;
            __pyx_L11_bool_binop_done:;
            if (__pyx_t_11) {
/* … */
            }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">290</span>:                     <span class="k">continue</span></pre>
<pre class='cython code score-0 '>              goto __pyx_L8_continue;
/* … */
              goto __pyx_L8_continue;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">291</span>:                 <span class="k">if</span> <span class="n">mmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">mmask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>            __pyx_t_12 = ((((PyObject *) __pyx_v_mmask.memview) != Py_None) != 0);
            if (__pyx_t_12) {
            } else {
              __pyx_t_11 = __pyx_t_12;
              goto __pyx_L14_bool_binop_done;
            }
            __pyx_t_15 = __pyx_v_i;
            __pyx_t_16 = __pyx_v_j;
            __pyx_t_12 = (((*((int *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mmask.data + __pyx_t_15 * __pyx_v_mmask.strides[0]) ) + __pyx_t_16 * __pyx_v_mmask.strides[1]) ))) == 0) != 0);
            __pyx_t_11 = __pyx_t_12;
            __pyx_L14_bool_binop_done:;
            if (__pyx_t_11) {
/* … */
            }
/* … */
            __pyx_t_12 = ((((PyObject *) __pyx_v_mmask.memview) != Py_None) != 0);
            if (__pyx_t_12) {
            } else {
              __pyx_t_11 = __pyx_t_12;
              goto __pyx_L14_bool_binop_done;
            }
            __pyx_t_15 = __pyx_v_i;
            __pyx_t_16 = __pyx_v_j;
            __pyx_t_12 = (((*((int *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mmask.data + __pyx_t_15 * __pyx_v_mmask.strides[0]) ) + __pyx_t_16 * __pyx_v_mmask.strides[1]) ))) == 0) != 0);
            __pyx_t_11 = __pyx_t_12;
            __pyx_L14_bool_binop_done:;
            if (__pyx_t_11) {
/* … */
            }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">292</span>:                     <span class="k">continue</span></pre>
<pre class='cython code score-0 '>              goto __pyx_L8_continue;
/* … */
              goto __pyx_L8_continue;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">293</span>:                 <span class="n">valid_points</span> <span class="o">+=</span> <span class="mf">1</span></pre>
<pre class='cython code score-0 '>            __pyx_v_valid_points = (__pyx_v_valid_points + 1);
/* … */
            __pyx_v_valid_points = (__pyx_v_valid_points + 1);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">294</span>:                 <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_apply_affine_2d_x0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>            __pyx_t_17 = 0;
            *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_17 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_2d_x0(__pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
/* … */
            __pyx_t_17 = 0;
            *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_17 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_2d_x0(__pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">295</span>:                 <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_apply_affine_2d_x1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>            __pyx_t_18 = 1;
            *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_18 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_2d_x1(__pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
/* … */
            __pyx_t_18 = 1;
            *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_18 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_2d_x1(__pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
</pre><pre class="cython line score-0">&#xA0;<span class="">296</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">297</span>:                 <span class="k">if</span> <span class="n">constant_jacobian</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>            __pyx_t_11 = ((__pyx_v_constant_jacobian == 0) != 0);
            if (__pyx_t_11) {
/* … */
            }
/* … */
            __pyx_t_11 = ((__pyx_v_constant_jacobian == 0) != 0);
            if (__pyx_t_11) {
/* … */
            }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">298</span>:                     <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>              __pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_v_x, __pyx_v_J);
/* … */
              __pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_v_x, __pyx_v_J);
</pre><pre class="cython line score-0">&#xA0;<span class="">299</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">300</span>:                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>            __pyx_t_19 = __pyx_v_n;
            for (__pyx_t_20 = 0; __pyx_t_20 &lt; __pyx_t_19; __pyx_t_20+=1) {
              __pyx_v_k = __pyx_t_20;
/* … */
            __pyx_t_19 = __pyx_v_n;
            for (__pyx_t_20 = 0; __pyx_t_20 &lt; __pyx_t_19; __pyx_t_20+=1) {
              __pyx_v_k = __pyx_t_20;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">301</span>:                     <span class="n">grad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">+</span></pre>
<pre class='cython code score-0 '>              __pyx_t_21 = 0;
              __pyx_t_22 = __pyx_v_k;
              __pyx_t_23 = __pyx_v_i;
              __pyx_t_24 = __pyx_v_j;
              __pyx_t_25 = 0;
/* … */
              __pyx_t_31 = __pyx_v_k;
              *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_31 * __pyx_v_grad.strides[0]) )) = (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_21 * __pyx_v_J.strides[0]) ) + __pyx_t_22 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_23 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_24 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_25 * __pyx_v_mgradient.strides[2]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_26 * __pyx_v_J.strides[0]) ) + __pyx_t_27 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_28 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_29 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_30 * __pyx_v_mgradient.strides[2]) )))));
            }
            __pyx_L8_continue:;
          }
        }
      }
/* … */
              __pyx_t_21 = 0;
              __pyx_t_22 = __pyx_v_k;
              __pyx_t_23 = __pyx_v_i;
              __pyx_t_24 = __pyx_v_j;
              __pyx_t_25 = 0;
/* … */
              __pyx_t_31 = __pyx_v_k;
              *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_31 * __pyx_v_grad.strides[0]) )) = (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_21 * __pyx_v_J.strides[0]) ) + __pyx_t_22 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_23 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_24 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_25 * __pyx_v_mgradient.strides[2]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_26 * __pyx_v_J.strides[0]) ) + __pyx_t_27 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_28 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_29 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_30 * __pyx_v_mgradient.strides[2]) )))));
            }
            __pyx_L8_continue:;
          }
        }
      }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">302</span>:                                <span class="n">J</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">])</span></pre>
<pre class='cython code score-0 '>              __pyx_t_26 = 1;
              __pyx_t_27 = __pyx_v_k;
              __pyx_t_28 = __pyx_v_i;
              __pyx_t_29 = __pyx_v_j;
              __pyx_t_30 = 1;
/* … */
              __pyx_t_26 = 1;
              __pyx_t_27 = __pyx_v_k;
              __pyx_t_28 = __pyx_v_i;
              __pyx_t_29 = __pyx_v_j;
              __pyx_t_30 = 1;
</pre><pre class="cython line score-0">&#xA0;<span class="">303</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">304</span>: </pre>
<pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">305</span>: <span class="k">cdef</span> <span class="nf">_gradient_dense_3d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">theta</span><span class="p">,</span> <span class="n">Transform</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-14 '>static PyObject *__pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_3d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_static, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_moving, __Pyx_memviewslice __pyx_v_grid2world, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_smask, __Pyx_memviewslice __pyx_v_mmask, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_nslices;
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_valid_points;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_l;
  npy_intp __pyx_v_k;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_x = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_0_gradient_dense_3d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_dense_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_x, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_dense_3d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_static, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_moving, __Pyx_memviewslice __pyx_v_grid2world, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_smask, __Pyx_memviewslice __pyx_v_mmask, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_nslices;
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_valid_points;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_l;
  npy_intp __pyx_v_k;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_x = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_1_gradient_dense_3d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_6, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_dense_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_x, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">306</span>:                                   <span class="n">double</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">static</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">307</span>:                                   <span class="n">double</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">moving</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">308</span>:                                   <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">grid2world</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">309</span>:                                   <span class="n">floating</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">mgradient</span><span class="p">,</span><span class="nb">int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">smask</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">310</span>:                                   <span class="nb">int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">mmask</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">311</span>:                                   <span class="n">double</span><span class="p">[:]</span> <span class="n">grad</span><span class="p">):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">312</span>:     <span class="s">r&quot;&quot;&quot; Gradient of the metric  w.r.t. transform parameters theta</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">313</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">314</span>: <span class="s">    Computes the vector of partial derivatives of the  w.r.t.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">315</span>: <span class="s">    each transformation parameter. The transformation itself is not necessary</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">316</span>: <span class="s">    to compute the gradient, but only its Jacobian.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">317</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">318</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">319</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">320</span>: <span class="s">    theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">321</span>: <span class="s">        parameters of the transformation to compute the gradient from</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">322</span>: <span class="s">    transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">323</span>: <span class="s">        the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">324</span>: <span class="s">        must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">325</span>: <span class="s">    static : array, shape (S, R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">326</span>: <span class="s">        static image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">327</span>: <span class="s">    moving : array, shape (S, R, C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">328</span>: <span class="s">        moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">329</span>: <span class="s">    grid2world : array, shape (4, 4)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">330</span>: <span class="s">        the grid-to-space transform associated with images static and moving</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">331</span>: <span class="s">        (we assume that both images have already been sampled at a common grid)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">332</span>: <span class="s">    mgradient : array, shape (S, R, C, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">333</span>: <span class="s">        the gradient of the moving image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">334</span>: <span class="s">    grad: array, shape (len(theta),)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">335</span>: <span class="s">        the array to write the gradient to</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">336</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">337</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">338</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nslices</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nslices = (__pyx_v_static.shape[0]);
/* … */
  __pyx_v_nslices = (__pyx_v_static.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">339</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nrows</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nrows = (__pyx_v_static.shape[1]);
/* … */
  __pyx_v_nrows = (__pyx_v_static.shape[1]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">340</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_ncols = (__pyx_v_static.shape[2]);
/* … */
  __pyx_v_ncols = (__pyx_v_static.shape[2]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">341</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_theta.shape[0]);
/* … */
  __pyx_v_n = (__pyx_v_theta.shape[0]);
</pre><pre class="cython line score-0">&#xA0;<span class="">342</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">offset</span><span class="p">,</span> <span class="n">valid_points</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">343</span>:         <span class="nb">int</span> <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_constant_jacobian = 0;
/* … */
  __pyx_v_constant_jacobian = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">344</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">345</span>:         <span class="n">double</span> <span class="n">rn</span><span class="p">,</span> <span class="n">cn</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">346</span>:         <span class="n">double</span> <span class="n">val</span><span class="p">,</span> <span class="n">spline_arg</span><span class="p">,</span> <span class="n">norm_factor</span></pre>
<pre class="cython line score-82" onclick='toggleDiv(this)'>+<span class="">347</span>:         <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-82 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
/* … */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 347, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
</pre><pre class="cython line score-70" onclick='toggleDiv(this)'>+<span class="">348</span>:         <span class="n">double</span><span class="p">[:]</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-70 '>  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_shape, __pyx_tuple__11) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_4);
  if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_x = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
/* … */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
/* … */
  __pyx_tuple__11 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_int_3);<span class='error_goto'> if (unlikely(!__pyx_tuple__11)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__11);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__11);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_shape, __pyx_tuple__12) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_empty_tuple, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_6 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(__pyx_t_4);
  if (unlikely(!__pyx_t_6.memview)) <span class='error_goto'>__PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_x = __pyx_t_6;
  __pyx_t_6.memview = NULL;
  __pyx_t_6.data = NULL;
  __pyx_tuple__12 = <span class='py_c_api'>PyTuple_Pack</span>(1, __pyx_int_3);<span class='error_goto'> if (unlikely(!__pyx_tuple__12)) __PYX_ERR(0, 348, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__12);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__12);
</pre><pre class="cython line score-0">&#xA0;<span class="">349</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">350</span>:     <span class="n">grad</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
/* … */
  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
</pre><pre class="cython line score-8" onclick='toggleDiv(this)'>+<span class="">351</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-8 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
/* … */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">352</span>:         <span class="n">valid_points</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_valid_points = 0;
/* … */
        __pyx_v_valid_points = 0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">353</span>:         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nslices</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_7 = __pyx_v_nslices;
        for (__pyx_t_8 = 0; __pyx_t_8 &lt; __pyx_t_7; __pyx_t_8+=1) {
          __pyx_v_k = __pyx_t_8;
/* … */
        __pyx_t_7 = __pyx_v_nslices;
        for (__pyx_t_8 = 0; __pyx_t_8 &lt; __pyx_t_7; __pyx_t_8+=1) {
          __pyx_v_k = __pyx_t_8;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">354</span>:             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_9 = __pyx_v_nrows;
          for (__pyx_t_10 = 0; __pyx_t_10 &lt; __pyx_t_9; __pyx_t_10+=1) {
            __pyx_v_i = __pyx_t_10;
/* … */
          __pyx_t_9 = __pyx_v_nrows;
          for (__pyx_t_10 = 0; __pyx_t_10 &lt; __pyx_t_9; __pyx_t_10+=1) {
            __pyx_v_i = __pyx_t_10;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">355</span>:                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>            __pyx_t_11 = __pyx_v_ncols;
            for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
              __pyx_v_j = __pyx_t_12;
/* … */
            __pyx_t_11 = __pyx_v_ncols;
            for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
              __pyx_v_j = __pyx_t_12;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">356</span>:                     <span class="k">if</span> <span class="n">smask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">smask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>              __pyx_t_14 = ((((PyObject *) __pyx_v_smask.memview) != Py_None) != 0);
              if (__pyx_t_14) {
              } else {
                __pyx_t_13 = __pyx_t_14;
                goto __pyx_L13_bool_binop_done;
              }
              __pyx_t_15 = __pyx_v_k;
              __pyx_t_16 = __pyx_v_i;
              __pyx_t_17 = __pyx_v_j;
              __pyx_t_14 = (((*((int *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_smask.data + __pyx_t_15 * __pyx_v_smask.strides[0]) ) + __pyx_t_16 * __pyx_v_smask.strides[1]) ) + __pyx_t_17 * __pyx_v_smask.strides[2]) ))) == 0) != 0);
              __pyx_t_13 = __pyx_t_14;
              __pyx_L13_bool_binop_done:;
              if (__pyx_t_13) {
/* … */
              }
/* … */
              __pyx_t_14 = ((((PyObject *) __pyx_v_smask.memview) != Py_None) != 0);
              if (__pyx_t_14) {
              } else {
                __pyx_t_13 = __pyx_t_14;
                goto __pyx_L13_bool_binop_done;
              }
              __pyx_t_15 = __pyx_v_k;
              __pyx_t_16 = __pyx_v_i;
              __pyx_t_17 = __pyx_v_j;
              __pyx_t_14 = (((*((int *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_smask.data + __pyx_t_15 * __pyx_v_smask.strides[0]) ) + __pyx_t_16 * __pyx_v_smask.strides[1]) ) + __pyx_t_17 * __pyx_v_smask.strides[2]) ))) == 0) != 0);
              __pyx_t_13 = __pyx_t_14;
              __pyx_L13_bool_binop_done:;
              if (__pyx_t_13) {
/* … */
              }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">357</span>:                         <span class="k">continue</span></pre>
<pre class='cython code score-0 '>                goto __pyx_L10_continue;
/* … */
                goto __pyx_L10_continue;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">358</span>:                     <span class="k">if</span> <span class="n">mmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">mmask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>              __pyx_t_14 = ((((PyObject *) __pyx_v_mmask.memview) != Py_None) != 0);
              if (__pyx_t_14) {
              } else {
                __pyx_t_13 = __pyx_t_14;
                goto __pyx_L16_bool_binop_done;
              }
              __pyx_t_18 = __pyx_v_k;
              __pyx_t_19 = __pyx_v_i;
              __pyx_t_20 = __pyx_v_j;
              __pyx_t_14 = (((*((int *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mmask.data + __pyx_t_18 * __pyx_v_mmask.strides[0]) ) + __pyx_t_19 * __pyx_v_mmask.strides[1]) ) + __pyx_t_20 * __pyx_v_mmask.strides[2]) ))) == 0) != 0);
              __pyx_t_13 = __pyx_t_14;
              __pyx_L16_bool_binop_done:;
              if (__pyx_t_13) {
/* … */
              }
/* … */
              __pyx_t_14 = ((((PyObject *) __pyx_v_mmask.memview) != Py_None) != 0);
              if (__pyx_t_14) {
              } else {
                __pyx_t_13 = __pyx_t_14;
                goto __pyx_L16_bool_binop_done;
              }
              __pyx_t_18 = __pyx_v_k;
              __pyx_t_19 = __pyx_v_i;
              __pyx_t_20 = __pyx_v_j;
              __pyx_t_14 = (((*((int *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mmask.data + __pyx_t_18 * __pyx_v_mmask.strides[0]) ) + __pyx_t_19 * __pyx_v_mmask.strides[1]) ) + __pyx_t_20 * __pyx_v_mmask.strides[2]) ))) == 0) != 0);
              __pyx_t_13 = __pyx_t_14;
              __pyx_L16_bool_binop_done:;
              if (__pyx_t_13) {
/* … */
              }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">359</span>:                         <span class="k">continue</span></pre>
<pre class='cython code score-0 '>                goto __pyx_L10_continue;
/* … */
                goto __pyx_L10_continue;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">360</span>:                     <span class="n">valid_points</span> <span class="o">+=</span><span class="mf">1</span></pre>
<pre class='cython code score-0 '>              __pyx_v_valid_points = (__pyx_v_valid_points + 1);
/* … */
              __pyx_v_valid_points = (__pyx_v_valid_points + 1);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">361</span>:                     <span class="n">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_apply_affine_3d_x0</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>              __pyx_t_21 = 0;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_21 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x0(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
/* … */
              __pyx_t_21 = 0;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_21 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x0(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">362</span>:                     <span class="n">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_apply_affine_3d_x1</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>              __pyx_t_22 = 1;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_22 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x1(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
/* … */
              __pyx_t_22 = 1;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_22 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x1(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">363</span>:                     <span class="n">x</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_apply_affine_3d_x2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="n">grid2world</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>              __pyx_t_23 = 2;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_23 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x2(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
/* … */
              __pyx_t_23 = 2;
              *((double *) ( /* dim=0 */ (__pyx_v_x.data + __pyx_t_23 * __pyx_v_x.strides[0]) )) = __pyx_f_4dipy_5align_13vector_fields__apply_affine_3d_x2(__pyx_v_k, __pyx_v_i, __pyx_v_j, 1.0, __pyx_v_grid2world);
</pre><pre class="cython line score-0">&#xA0;<span class="">364</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">365</span>:                     <span class="k">if</span> <span class="n">constant_jacobian</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>              __pyx_t_13 = ((__pyx_v_constant_jacobian == 0) != 0);
              if (__pyx_t_13) {
/* … */
              }
/* … */
              __pyx_t_13 = ((__pyx_v_constant_jacobian == 0) != 0);
              if (__pyx_t_13) {
/* … */
              }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">366</span>:                         <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span></pre>
<pre class='cython code score-0 '>                __pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_v_x, __pyx_v_J);
/* … */
                __pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_v_x, __pyx_v_J);
</pre><pre class="cython line score-0">&#xA0;<span class="">367</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">368</span>:                     <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>              __pyx_t_24 = __pyx_v_n;
              for (__pyx_t_25 = 0; __pyx_t_25 &lt; __pyx_t_24; __pyx_t_25+=1) {
                __pyx_v_l = __pyx_t_25;
/* … */
              __pyx_t_24 = __pyx_v_n;
              for (__pyx_t_25 = 0; __pyx_t_25 &lt; __pyx_t_24; __pyx_t_25+=1) {
                __pyx_v_l = __pyx_t_25;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">369</span>:                         <span class="n">grad</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">+</span></pre>
<pre class='cython code score-0 '>                __pyx_t_26 = 0;
                __pyx_t_27 = __pyx_v_l;
                __pyx_t_28 = __pyx_v_k;
                __pyx_t_29 = __pyx_v_i;
                __pyx_t_30 = __pyx_v_j;
                __pyx_t_31 = 0;
/* … */
                __pyx_t_44 = __pyx_v_l;
                *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_44 * __pyx_v_grad.strides[0]) )) += ((((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_26 * __pyx_v_J.strides[0]) ) + __pyx_t_27 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_28 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_29 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_30 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_31 * __pyx_v_mgradient.strides[3]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_32 * __pyx_v_J.strides[0]) ) + __pyx_t_33 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_34 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_35 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_36 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_37 * __pyx_v_mgradient.strides[3]) ))))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_38 * __pyx_v_J.strides[0]) ) + __pyx_t_39 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_40 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_41 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_42 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_43 * __pyx_v_mgradient.strides[3]) )))));
              }
              __pyx_L10_continue:;
            }
          }
        }
      }
/* … */
                __pyx_t_26 = 0;
                __pyx_t_27 = __pyx_v_l;
                __pyx_t_28 = __pyx_v_k;
                __pyx_t_29 = __pyx_v_i;
                __pyx_t_30 = __pyx_v_j;
                __pyx_t_31 = 0;
/* … */
                __pyx_t_44 = __pyx_v_l;
                *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_44 * __pyx_v_grad.strides[0]) )) += ((((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_26 * __pyx_v_J.strides[0]) ) + __pyx_t_27 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_28 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_29 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_30 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_31 * __pyx_v_mgradient.strides[3]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_32 * __pyx_v_J.strides[0]) ) + __pyx_t_33 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_34 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_35 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_36 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_37 * __pyx_v_mgradient.strides[3]) ))))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_38 * __pyx_v_J.strides[0]) ) + __pyx_t_39 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=3 */ (( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_40 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_41 * __pyx_v_mgradient.strides[1]) ) + __pyx_t_42 * __pyx_v_mgradient.strides[2]) ) + __pyx_t_43 * __pyx_v_mgradient.strides[3]) )))));
              }
              __pyx_L10_continue:;
            }
          }
        }
      }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">370</span>:                                    <span class="n">J</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">1</span><span class="p">]</span> <span class="o">+</span></pre>
<pre class='cython code score-0 '>                __pyx_t_32 = 1;
                __pyx_t_33 = __pyx_v_l;
                __pyx_t_34 = __pyx_v_k;
                __pyx_t_35 = __pyx_v_i;
                __pyx_t_36 = __pyx_v_j;
                __pyx_t_37 = 1;
/* … */
                __pyx_t_32 = 1;
                __pyx_t_33 = __pyx_v_l;
                __pyx_t_34 = __pyx_v_k;
                __pyx_t_35 = __pyx_v_i;
                __pyx_t_36 = __pyx_v_j;
                __pyx_t_37 = 1;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">371</span>:                                    <span class="n">J</span><span class="p">[</span><span class="mf">2</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mf">2</span><span class="p">])</span></pre>
<pre class='cython code score-0 '>                __pyx_t_38 = 2;
                __pyx_t_39 = __pyx_v_l;
                __pyx_t_40 = __pyx_v_k;
                __pyx_t_41 = __pyx_v_i;
                __pyx_t_42 = __pyx_v_j;
                __pyx_t_43 = 2;
/* … */
                __pyx_t_38 = 2;
                __pyx_t_39 = __pyx_v_l;
                __pyx_t_40 = __pyx_v_k;
                __pyx_t_41 = __pyx_v_i;
                __pyx_t_42 = __pyx_v_j;
                __pyx_t_43 = 2;
</pre><pre class="cython line score-0">&#xA0;<span class="">372</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">373</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">374</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">375</span>: </pre>
<pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">376</span>: <span class="k">cdef</span> <span class="nf">_gradient_sparse_2d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">theta</span><span class="p">,</span> <span class="n">Transform</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-14 '>static PyObject *__pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_2d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_sval, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_mval, __Pyx_memviewslice __pyx_v_sample_points, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_m;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_0_gradient_sparse_2d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_sparse_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_2d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_sval, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_mval, __Pyx_memviewslice __pyx_v_sample_points, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_m;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_1_gradient_sparse_2d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_sparse_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">377</span>:                                    <span class="n">double</span><span class="p">[:]</span> <span class="n">sval</span><span class="p">,</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">mval</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">378</span>:                                    <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">sample_points</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">379</span>:                                    <span class="n">floating</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">mgradient</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">380</span>:                                    <span class="n">double</span><span class="p">[:]</span> <span class="n">grad</span><span class="p">):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">381</span>:     <span class="s">r&quot;&quot;&quot; Gradient of the gradient w.r.t. transform parameters theta</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">382</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">383</span>: <span class="s">    Computes the vector of partial derivatives w.r.t.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">384</span>: <span class="s">    each transformation parameter. The transformation itself is not necessary</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">385</span>: <span class="s">    to compute the gradient, but only its Jacobian.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">386</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">387</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">388</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">389</span>: <span class="s">    theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">390</span>: <span class="s">        parameters to compute the gradient at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">391</span>: <span class="s">    transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">392</span>: <span class="s">        the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">393</span>: <span class="s">        must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">394</span>: <span class="s">    sval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">395</span>: <span class="s">        sampled intensities from the static image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">396</span>: <span class="s">    mval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">397</span>: <span class="s">        sampled intensities from the moving image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">398</span>: <span class="s">    sample_points : array, shape (m, 2)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">399</span>: <span class="s">        positions (in physical space) of the points the images were sampled at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">400</span>: <span class="s">    mgradient : array, shape (m, 2)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">401</span>: <span class="s">        the gradient of the moving image at the sample points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">402</span>: <span class="s">    grad : array, shape (len(theta))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">403</span>: <span class="s">        the array to write the gradient to</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">404</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">405</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">406</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_theta.shape[0]);
/* … */
  __pyx_v_n = (__pyx_v_theta.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">407</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sval</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_m = (__pyx_v_sval.shape[0]);
/* … */
  __pyx_v_m = (__pyx_v_sval.shape[0]);
</pre><pre class="cython line score-0">&#xA0;<span class="">408</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">offset</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">409</span>:         <span class="nb">int</span> <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_constant_jacobian = 0;
/* … */
  __pyx_v_constant_jacobian = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">410</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">valid_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">411</span>:         <span class="n">double</span> <span class="n">rn</span><span class="p">,</span> <span class="n">cn</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">412</span>:         <span class="n">double</span> <span class="n">val</span><span class="p">,</span> <span class="n">spline_arg</span><span class="p">,</span> <span class="n">norm_factor</span></pre>
<pre class="cython line score-82" onclick='toggleDiv(this)'>+<span class="">413</span>:         <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-82 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
/* … */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 413, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
</pre><pre class="cython line score-0">&#xA0;<span class="">414</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">415</span>:     <span class="n">grad</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
/* … */
  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
</pre><pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">416</span>:     <span class="k">print</span><span class="p">(</span><span class="s">&quot;Gradient ssd&quot;</span><span class="p">,</span><span class="n">grad</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>  __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_kp_s_Gradient_ssd);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_kp_s_Gradient_ssd);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_kp_s_Gradient_ssd);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
/* … */
  __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_kp_s_Gradient_ssd);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_kp_s_Gradient_ssd);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_kp_s_Gradient_ssd);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 416, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class="cython line score-12" onclick='toggleDiv(this)'>+<span class="">417</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-12 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }
/* … */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0">&#xA0;<span class="">418</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">419</span>:         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_6 = __pyx_v_m;
        for (__pyx_t_7 = 0; __pyx_t_7 &lt; __pyx_t_6; __pyx_t_7+=1) {
          __pyx_v_i = __pyx_t_7;
/* … */
        __pyx_t_6 = __pyx_v_m;
        for (__pyx_t_7 = 0; __pyx_t_7 &lt; __pyx_t_6; __pyx_t_7+=1) {
          __pyx_v_i = __pyx_t_7;
</pre><pre class="cython line score-0">&#xA0;<span class="">420</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">421</span>:             <span class="k">if</span> <span class="n">constant_jacobian</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>          __pyx_t_8 = ((__pyx_v_constant_jacobian == 0) != 0);
          if (__pyx_t_8) {
/* … */
          }
/* … */
          __pyx_t_8 = ((__pyx_v_constant_jacobian == 0) != 0);
          if (__pyx_t_8) {
/* … */
          }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">422</span>:                 <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span></pre>
<pre class='cython code score-0 '>__pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_t_9, __pyx_v_J);
/* … */
            __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 0);
            __pyx_t_9.memview = NULL;
            __pyx_t_9.data = NULL;
__pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_t_9, __pyx_v_J);
/* … */
            __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 0);
            __pyx_t_9.memview = NULL;
            __pyx_t_9.data = NULL;
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">423</span>:                                                         <span class="n">sample_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">J</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>            __pyx_t_9.data = __pyx_v_sample_points.data;
            __pyx_t_9.memview = __pyx_v_sample_points.memview;
            __PYX_INC_MEMVIEW(&amp;__pyx_t_9, 0);
            {
    Py_ssize_t __pyx_tmp_idx = __pyx_v_i;
    Py_ssize_t __pyx_tmp_shape = __pyx_v_sample_points.shape[0];
    Py_ssize_t __pyx_tmp_stride = __pyx_v_sample_points.strides[0];
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0))
        __pyx_tmp_idx += __pyx_tmp_shape;
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0 || __pyx_tmp_idx &gt;= __pyx_tmp_shape)) {
            #ifdef WITH_THREAD
            PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
            #endif
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_IndexError, "Index out of bounds (axis 0)");
            #ifdef WITH_THREAD
            PyGILState_Release(__pyx_gilstate_save);
            #endif
        <span class='error_goto'>__PYX_ERR(0, 423, __pyx_L4_error)</span>
    }
        __pyx_t_9.data += __pyx_tmp_idx * __pyx_tmp_stride;
}

__pyx_t_9.shape[0] = __pyx_v_sample_points.shape[1];
__pyx_t_9.strides[0] = __pyx_v_sample_points.strides[1];
    __pyx_t_9.suboffsets[0] = -1;
/* … */
            __pyx_t_9.data = __pyx_v_sample_points.data;
            __pyx_t_9.memview = __pyx_v_sample_points.memview;
            __PYX_INC_MEMVIEW(&amp;__pyx_t_9, 0);
            {
    Py_ssize_t __pyx_tmp_idx = __pyx_v_i;
    Py_ssize_t __pyx_tmp_shape = __pyx_v_sample_points.shape[0];
    Py_ssize_t __pyx_tmp_stride = __pyx_v_sample_points.strides[0];
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0))
        __pyx_tmp_idx += __pyx_tmp_shape;
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0 || __pyx_tmp_idx &gt;= __pyx_tmp_shape)) {
            #ifdef WITH_THREAD
            PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
            #endif
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_IndexError, "Index out of bounds (axis 0)");
            #ifdef WITH_THREAD
            PyGILState_Release(__pyx_gilstate_save);
            #endif
        <span class='error_goto'>__PYX_ERR(0, 423, __pyx_L4_error)</span>
    }
        __pyx_t_9.data += __pyx_tmp_idx * __pyx_tmp_stride;
}

__pyx_t_9.shape[0] = __pyx_v_sample_points.shape[1];
__pyx_t_9.strides[0] = __pyx_v_sample_points.strides[1];
    __pyx_t_9.suboffsets[0] = -1;

</pre><pre class="cython line score-0">&#xA0;<span class="">424</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">425</span>:             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_10 = __pyx_v_n;
          for (__pyx_t_11 = 0; __pyx_t_11 &lt; __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_j = __pyx_t_11;
/* … */
          __pyx_t_10 = __pyx_v_n;
          for (__pyx_t_11 = 0; __pyx_t_11 &lt; __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_j = __pyx_t_11;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">426</span>:                 <span class="n">grad</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">+</span></pre>
<pre class='cython code score-0 '>            __pyx_t_12 = 0;
            __pyx_t_13 = __pyx_v_j;
            __pyx_t_14 = __pyx_v_i;
            __pyx_t_15 = 0;
/* … */
            __pyx_t_20 = __pyx_v_j;
            *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_20 * __pyx_v_grad.strides[0]) )) = (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_12 * __pyx_v_J.strides[0]) ) + __pyx_t_13 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_14 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_15 * __pyx_v_mgradient.strides[1]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_16 * __pyx_v_J.strides[0]) ) + __pyx_t_17 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_18 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_19 * __pyx_v_mgradient.strides[1]) )))));
          }
        }
      }
/* … */
            __pyx_t_12 = 0;
            __pyx_t_13 = __pyx_v_j;
            __pyx_t_14 = __pyx_v_i;
            __pyx_t_15 = 0;
/* … */
            __pyx_t_20 = __pyx_v_j;
            *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_20 * __pyx_v_grad.strides[0]) )) = (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_12 * __pyx_v_J.strides[0]) ) + __pyx_t_13 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_14 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_15 * __pyx_v_mgradient.strides[1]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_16 * __pyx_v_J.strides[0]) ) + __pyx_t_17 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_18 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_19 * __pyx_v_mgradient.strides[1]) )))));
          }
        }
      }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">427</span>:                            <span class="n">J</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mf">1</span><span class="p">])</span></pre>
<pre class='cython code score-0 '>            __pyx_t_16 = 1;
            __pyx_t_17 = __pyx_v_j;
            __pyx_t_18 = __pyx_v_i;
            __pyx_t_19 = 1;
/* … */
            __pyx_t_16 = 1;
            __pyx_t_17 = __pyx_v_j;
            __pyx_t_18 = __pyx_v_i;
            __pyx_t_19 = 1;
</pre><pre class="cython line score-0">&#xA0;<span class="">428</span>: </pre>
<pre class="cython line score-22" onclick='toggleDiv(this)'>+<span class="">429</span>:     <span class="k">print</span><span class="p">(</span><span class="s">&quot;Gradient ssd2&quot;</span><span class="p">,</span><span class="n">grad</span><span class="p">)</span></pre>
<pre class='cython code score-22 '>  __pyx_t_1 = __pyx_memoryview_fromslice(__pyx_v_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_kp_s_Gradient_ssd2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_kp_s_Gradient_ssd2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_kp_s_Gradient_ssd2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1, __pyx_t_1);
  __pyx_t_1 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
/* … */
  __pyx_t_1 = __pyx_memoryview_fromslice(__pyx_v_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_kp_s_Gradient_ssd2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_kp_s_Gradient_ssd2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_kp_s_Gradient_ssd2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1, __pyx_t_1);
  __pyx_t_1 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 429, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">430</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">431</span>: </pre>
<pre class="cython line score-14" onclick='toggleDiv(this)'>+<span class="">432</span>: <span class="k">cdef</span> <span class="nf">_gradient_sparse_3d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">theta</span><span class="p">,</span> <span class="n">Transform</span> <span class="n">transform</span><span class="p">,</span></pre>
<pre class='cython code score-14 '>static PyObject *__pyx_fuse_0__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_3d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_sval, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_mval, __Pyx_memviewslice __pyx_v_sample_points, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_m;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_0_gradient_sparse_3d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_sparse_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_fuse_1__pyx_f_4dipy_5align_9ssdmetric__gradient_sparse_3d(__Pyx_memviewslice __pyx_v_theta, struct __pyx_obj_4dipy_5align_10transforms_Transform *__pyx_v_transform, __Pyx_memviewslice __pyx_v_sval, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_mval, __Pyx_memviewslice __pyx_v_sample_points, __Pyx_memviewslice __pyx_v_mgradient, __Pyx_memviewslice __pyx_v_grad) {
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_m;
  int __pyx_v_constant_jacobian;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  __Pyx_memviewslice __pyx_v_J = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("__pyx_fuse_1_gradient_sparse_3d", 0);
/* … */
  /* function exit code */
  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_5, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 1);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric._gradient_sparse_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_J, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
</pre><pre class="cython line score-0">&#xA0;<span class="">433</span>:                                    <span class="n">double</span><span class="p">[:]</span> <span class="n">sval</span><span class="p">,</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">mval</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">434</span>:                                    <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">sample_points</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">435</span>:                                    <span class="n">floating</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">mgradient</span><span class="p">,</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">436</span>:                                    <span class="n">double</span><span class="p">[:]</span> <span class="n">grad</span><span class="p">):</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">437</span>:     <span class="s">r&quot;&quot;&quot; Gradient of the  w.r.t. transform parameters theta</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">438</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">439</span>: <span class="s">    Computes the vector of partial derivatives of the joint histogram w.r.t.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">440</span>: <span class="s">    each transformation parameter. The transformation itself is not necessary</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">441</span>: <span class="s">    to compute the gradient, but only its Jacobian.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">442</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">443</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">444</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">445</span>: <span class="s">    theta : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">446</span>: <span class="s">        parameters to compute the gradient at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">447</span>: <span class="s">    transform : instance of Transform</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">448</span>: <span class="s">        the transformation with respect to whose parameters the gradient</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">449</span>: <span class="s">        must be computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">450</span>: <span class="s">    sval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">451</span>: <span class="s">        sampled intensities from the static image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">452</span>: <span class="s">    mval : array, shape (m,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">453</span>: <span class="s">        sampled intensities from the moving image at sampled_points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">454</span>: <span class="s">    sample_points : array, shape (m, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">455</span>: <span class="s">        positions (in physical space) of the points the images were sampled at</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">456</span>: <span class="s">    mgradient : array, shape (m, 3)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">457</span>: <span class="s">        the gradient of the moving image at the sample points</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">458</span>: <span class="s">    </span></pre>
<pre class="cython line score-0">&#xA0;<span class="">459</span>: <span class="s">    grad : array, shape ( len(theta))</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">460</span>: <span class="s">        the array to write the gradient to</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">461</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">462</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">463</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_theta.shape[0]);
/* … */
  __pyx_v_n = (__pyx_v_theta.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">464</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sval</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_m = (__pyx_v_sval.shape[0]);
/* … */
  __pyx_v_m = (__pyx_v_sval.shape[0]);
</pre><pre class="cython line score-0">&#xA0;<span class="">465</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">offset</span><span class="p">,</span> <span class="n">valid_points</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">466</span>:         <span class="nb">int</span> <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  __pyx_v_constant_jacobian = 0;
/* … */
  __pyx_v_constant_jacobian = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">467</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">468</span>:         <span class="n">double</span> <span class="n">rn</span><span class="p">,</span> <span class="n">cn</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">469</span>:         <span class="n">double</span> <span class="n">val</span><span class="p">,</span> <span class="n">spline_arg</span><span class="p">,</span> <span class="n">norm_factor</span></pre>
<pre class="cython line score-82" onclick='toggleDiv(this)'>+<span class="">470</span>:         <span class="n">double</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></pre>
<pre class='cython code score-82 '>  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
/* … */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_1, __pyx_n_s_empty);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyDict_NewPresized</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyInt_From_Py_intptr_t</span>(__pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_int_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_int_3);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_3 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_shape, __pyx_t_4) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_float64);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_3) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_empty_tuple, __pyx_t_1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(__pyx_t_3);
  if (unlikely(!__pyx_t_5.memview)) <span class='error_goto'>__PYX_ERR(0, 470, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_J = __pyx_t_5;
  __pyx_t_5.memview = NULL;
  __pyx_t_5.data = NULL;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">471</span>:     <span class="n">grad</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
/* … */
  {
      double __pyx_temp_scalar = 0.0;
      {
          Py_ssize_t __pyx_temp_extent_0 = __pyx_v_grad.shape[0];
          Py_ssize_t __pyx_temp_stride_0 = __pyx_v_grad.strides[0];
          char *__pyx_temp_pointer_0;
          Py_ssize_t __pyx_temp_idx_0;
          __pyx_temp_pointer_0 = __pyx_v_grad.data;
          for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
            *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
            __pyx_temp_pointer_0 += __pyx_temp_stride_0;
          }
      }
  }
</pre><pre class="cython line score-12" onclick='toggleDiv(this)'>+<span class="">472</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-12 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }
/* … */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">473</span>:         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_6 = __pyx_v_m;
        for (__pyx_t_7 = 0; __pyx_t_7 &lt; __pyx_t_6; __pyx_t_7+=1) {
          __pyx_v_i = __pyx_t_7;
/* … */
        __pyx_t_6 = __pyx_v_m;
        for (__pyx_t_7 = 0; __pyx_t_7 &lt; __pyx_t_6; __pyx_t_7+=1) {
          __pyx_v_i = __pyx_t_7;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">474</span>:             <span class="k">if</span> <span class="n">constant_jacobian</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>          __pyx_t_8 = ((__pyx_v_constant_jacobian == 0) != 0);
          if (__pyx_t_8) {
/* … */
          }
/* … */
          __pyx_t_8 = ((__pyx_v_constant_jacobian == 0) != 0);
          if (__pyx_t_8) {
/* … */
          }
</pre><pre class="cython line score-10" onclick='toggleDiv(this)'>+<span class="">475</span>:                 <span class="n">constant_jacobian</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">_jacobian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">sample_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">J</span><span class="p">)</span></pre>
<pre class='cython code score-10 '>            __pyx_t_9.data = __pyx_v_sample_points.data;
            __pyx_t_9.memview = __pyx_v_sample_points.memview;
            __PYX_INC_MEMVIEW(&amp;__pyx_t_9, 0);
            {
    Py_ssize_t __pyx_tmp_idx = __pyx_v_i;
    Py_ssize_t __pyx_tmp_shape = __pyx_v_sample_points.shape[0];
    Py_ssize_t __pyx_tmp_stride = __pyx_v_sample_points.strides[0];
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0))
        __pyx_tmp_idx += __pyx_tmp_shape;
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0 || __pyx_tmp_idx &gt;= __pyx_tmp_shape)) {
            #ifdef WITH_THREAD
            PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
            #endif
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_IndexError, "Index out of bounds (axis 0)");
            #ifdef WITH_THREAD
            PyGILState_Release(__pyx_gilstate_save);
            #endif
        <span class='error_goto'>__PYX_ERR(0, 475, __pyx_L4_error)</span>
    }
        __pyx_t_9.data += __pyx_tmp_idx * __pyx_tmp_stride;
}

__pyx_t_9.shape[0] = __pyx_v_sample_points.shape[1];
__pyx_t_9.strides[0] = __pyx_v_sample_points.strides[1];
    __pyx_t_9.suboffsets[0] = -1;

__pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_t_9, __pyx_v_J);
            __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 0);
            __pyx_t_9.memview = NULL;
            __pyx_t_9.data = NULL;
/* … */
            __pyx_t_9.data = __pyx_v_sample_points.data;
            __pyx_t_9.memview = __pyx_v_sample_points.memview;
            __PYX_INC_MEMVIEW(&amp;__pyx_t_9, 0);
            {
    Py_ssize_t __pyx_tmp_idx = __pyx_v_i;
    Py_ssize_t __pyx_tmp_shape = __pyx_v_sample_points.shape[0];
    Py_ssize_t __pyx_tmp_stride = __pyx_v_sample_points.strides[0];
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0))
        __pyx_tmp_idx += __pyx_tmp_shape;
    if (0 &amp;&amp; (__pyx_tmp_idx &lt; 0 || __pyx_tmp_idx &gt;= __pyx_tmp_shape)) {
            #ifdef WITH_THREAD
            PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
            #endif
        <span class='py_c_api'>PyErr_SetString</span>(PyExc_IndexError, "Index out of bounds (axis 0)");
            #ifdef WITH_THREAD
            PyGILState_Release(__pyx_gilstate_save);
            #endif
        <span class='error_goto'>__PYX_ERR(0, 475, __pyx_L4_error)</span>
    }
        __pyx_t_9.data += __pyx_tmp_idx * __pyx_tmp_stride;
}

__pyx_t_9.shape[0] = __pyx_v_sample_points.shape[1];
__pyx_t_9.strides[0] = __pyx_v_sample_points.strides[1];
    __pyx_t_9.suboffsets[0] = -1;

__pyx_v_constant_jacobian = ((struct __pyx_vtabstruct_4dipy_5align_10transforms_Transform *)__pyx_v_transform-&gt;__pyx_vtab)-&gt;_jacobian(__pyx_v_transform, __pyx_v_theta, __pyx_t_9, __pyx_v_J);
            __PYX_XDEC_MEMVIEW(&amp;__pyx_t_9, 0);
            __pyx_t_9.memview = NULL;
            __pyx_t_9.data = NULL;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">476</span>:             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_10 = __pyx_v_n;
          for (__pyx_t_11 = 0; __pyx_t_11 &lt; __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_j = __pyx_t_11;
/* … */
          __pyx_t_10 = __pyx_v_n;
          for (__pyx_t_11 = 0; __pyx_t_11 &lt; __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_j = __pyx_t_11;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">477</span>:                 <span class="n">grad</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">J</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">J</span><span class="p">[</span><span class="mf">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mgradient</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mf">2</span><span class="p">])</span></pre>
<pre class='cython code score-0 '>            __pyx_t_12 = 0;
            __pyx_t_13 = __pyx_v_j;
            __pyx_t_14 = __pyx_v_i;
            __pyx_t_15 = 0;
            __pyx_t_16 = 1;
            __pyx_t_17 = __pyx_v_j;
            __pyx_t_18 = __pyx_v_i;
            __pyx_t_19 = 1;
            __pyx_t_20 = 2;
            __pyx_t_21 = __pyx_v_j;
            __pyx_t_22 = __pyx_v_i;
            __pyx_t_23 = 2;
            __pyx_t_24 = __pyx_v_j;
            *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_24 * __pyx_v_grad.strides[0]) )) = ((((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_12 * __pyx_v_J.strides[0]) ) + __pyx_t_13 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_14 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_15 * __pyx_v_mgradient.strides[1]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_16 * __pyx_v_J.strides[0]) ) + __pyx_t_17 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_18 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_19 * __pyx_v_mgradient.strides[1]) ))))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_20 * __pyx_v_J.strides[0]) ) + __pyx_t_21 * __pyx_v_J.strides[1]) ))) * (*((float *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_22 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_23 * __pyx_v_mgradient.strides[1]) )))));
          }
        }
      }
/* … */
            __pyx_t_12 = 0;
            __pyx_t_13 = __pyx_v_j;
            __pyx_t_14 = __pyx_v_i;
            __pyx_t_15 = 0;
            __pyx_t_16 = 1;
            __pyx_t_17 = __pyx_v_j;
            __pyx_t_18 = __pyx_v_i;
            __pyx_t_19 = 1;
            __pyx_t_20 = 2;
            __pyx_t_21 = __pyx_v_j;
            __pyx_t_22 = __pyx_v_i;
            __pyx_t_23 = 2;
            __pyx_t_24 = __pyx_v_j;
            *((double *) ( /* dim=0 */ (__pyx_v_grad.data + __pyx_t_24 * __pyx_v_grad.strides[0]) )) = ((((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_12 * __pyx_v_J.strides[0]) ) + __pyx_t_13 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_14 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_15 * __pyx_v_mgradient.strides[1]) )))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_16 * __pyx_v_J.strides[0]) ) + __pyx_t_17 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_18 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_19 * __pyx_v_mgradient.strides[1]) ))))) + ((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_J.data + __pyx_t_20 * __pyx_v_J.strides[0]) ) + __pyx_t_21 * __pyx_v_J.strides[1]) ))) * (*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_mgradient.data + __pyx_t_22 * __pyx_v_mgradient.strides[0]) ) + __pyx_t_23 * __pyx_v_mgradient.strides[1]) )))));
          }
        }
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">478</span>: </pre>
<pre class="cython line score-61" onclick='toggleDiv(this)'>+<span class="">479</span>: <span class="k">def</span> <span class="nf">compute_ssd_mi_2d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span><span class="n">ssd_grad</span><span class="p">,</span> <span class="n">double</span><span class="p">[:,:]</span> <span class="n">delta</span><span class="p">,</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">mi_gradient</span><span class="p">):</span></pre>
<pre class='cython code score-61 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_1compute_ssd_mi_2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_compute_ssd_mi_2d[] = " Computes the ssd and its gradient (if requested)\n\n    Parameters\n    ----------\n    ssd_grad : array, shape (n, )\n        gradient with respect to transformation parameters\n    delta : array, shape (R,C)\n        gradient between moving and static image\n    mi_gradient : array, shape (n,)\n        the buffer in which to write the gradient of the mutual information.\n        If None, the gradient is not computed\n    ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_1compute_ssd_mi_2d = {"compute_ssd_mi_2d", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_1compute_ssd_mi_2d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_compute_ssd_mi_2d};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_1compute_ssd_mi_2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  __Pyx_memviewslice __pyx_v_ssd_grad = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_delta = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_mi_gradient = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_ssd_mi_2d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_ssd_grad,&amp;__pyx_n_s_delta,&amp;__pyx_n_s_mi_gradient,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_ssd_grad)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_delta)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_2d", 1, 3, 3, 1); <span class='error_goto'>__PYX_ERR(0, 479, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mi_gradient)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_2d", 1, 3, 3, 2); <span class='error_goto'>__PYX_ERR(0, 479, __pyx_L3_error)</span>
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "compute_ssd_mi_2d") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 479, __pyx_L3_error)</span>
      }
    } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
    }
    __pyx_v_ssd_grad = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(values[0]);<span class='error_goto'> if (unlikely(!__pyx_v_ssd_grad.memview)) __PYX_ERR(0, 479, __pyx_L3_error)</span>
    __pyx_v_delta = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsds_double</span>(values[1]);<span class='error_goto'> if (unlikely(!__pyx_v_delta.memview)) __PYX_ERR(0, 479, __pyx_L3_error)</span>
    __pyx_v_mi_gradient = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(values[2]);<span class='error_goto'> if (unlikely(!__pyx_v_mi_gradient.memview)) __PYX_ERR(0, 479, __pyx_L3_error)</span>
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_2d", 1, 3, 3, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 479, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.compute_ssd_mi_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_compute_ssd_mi_2d(__pyx_self, __pyx_v_ssd_grad, __pyx_v_delta, __pyx_v_mi_gradient);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_compute_ssd_mi_2d(CYTHON_UNUSED PyObject *__pyx_self, __Pyx_memviewslice __pyx_v_ssd_grad, __Pyx_memviewslice __pyx_v_delta, __Pyx_memviewslice __pyx_v_mi_gradient) {
  double __pyx_v_epsilon;
  double __pyx_v_metric_value;
  double __pyx_v_delta_2;
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  npy_intp __pyx_v_k;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_ssd_mi_2d", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_14);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.compute_ssd_mi_2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_ssd_grad, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_delta, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_mi_gradient, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__56 = <span class='py_c_api'>PyTuple_Pack</span>(12, __pyx_n_s_ssd_grad, __pyx_n_s_delta, __pyx_n_s_mi_gradient, __pyx_n_s_epsilon, __pyx_n_s_metric_value, __pyx_n_s_delta_2, __pyx_n_s_nrows, __pyx_n_s_ncols, __pyx_n_s_n, __pyx_n_s_i, __pyx_n_s_j, __pyx_n_s_k);<span class='error_goto'> if (unlikely(!__pyx_tuple__56)) __PYX_ERR(0, 479, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__56);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__56);
/* … */
  __pyx_t_1 = PyCFunction_NewEx(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_1compute_ssd_mi_2d, NULL, __pyx_n_s_dipy_align_ssdmetric);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 479, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_compute_ssd_mi_2d, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 479, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_codeobj__57 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(3, 0, 12, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__56, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_compute_ssd_mi_2d, 479, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__57)) __PYX_ERR(0, 479, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">480</span>:     <span class="s">r&quot;&quot;&quot; Computes the ssd and its gradient (if requested)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">481</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">482</span>: <span class="s">    Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">483</span>: <span class="s">    ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">484</span>: <span class="s">    ssd_grad : array, shape (n, )</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">485</span>: <span class="s">        gradient with respect to transformation parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">486</span>: <span class="s">    delta : array, shape (R,C)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">487</span>: <span class="s">        gradient between moving and static image</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">488</span>: <span class="s">    mi_gradient : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">489</span>: <span class="s">        the buffer in which to write the gradient of the mutual information.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">490</span>: <span class="s">        If None, the gradient is not computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">491</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">492</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">493</span>:         <span class="n">double</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">2.2204460492503131e-016</span></pre>
<pre class='cython code score-0 '>  __pyx_v_epsilon = 2.2204460492503131e-016;
</pre><pre class="cython line score-0">&#xA0;<span class="">494</span>:         <span class="n">double</span> <span class="n">metric_value</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">495</span>:         <span class="n">double</span> <span class="n">delta_2</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">496</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nrows</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nrows = (__pyx_v_delta.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">497</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_ncols = (__pyx_v_delta.shape[1]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">498</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ssd_grad</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_ssd_grad.shape[0]);
</pre><pre class="cython line score-0">&#xA0;<span class="">499</span>: </pre>
<pre class="cython line score-4" onclick='toggleDiv(this)'>+<span class="">500</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-4 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">501</span>:         <span class="n">mi_gradient</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        {
            double __pyx_temp_scalar = 0.0;
            {
                Py_ssize_t __pyx_temp_extent_0 = __pyx_v_mi_gradient.shape[0];
                Py_ssize_t __pyx_temp_stride_0 = __pyx_v_mi_gradient.strides[0];
                char *__pyx_temp_pointer_0;
                Py_ssize_t __pyx_temp_idx_0;
                __pyx_temp_pointer_0 = __pyx_v_mi_gradient.data;
                for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
                  *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
                  __pyx_temp_pointer_0 += __pyx_temp_stride_0;
                }
            }
        }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">502</span>:         <span class="n">metric_value</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_metric_value = 0.0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">503</span>:         <span class="n">delta_2</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_delta_2 = 0.0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">504</span>:         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_1 = __pyx_v_nrows;
        for (__pyx_t_2 = 0; __pyx_t_2 &lt; __pyx_t_1; __pyx_t_2+=1) {
          __pyx_v_i = __pyx_t_2;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">505</span>:             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_3 = __pyx_v_ncols;
          for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_3; __pyx_t_4+=1) {
            __pyx_v_j = __pyx_t_4;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">506</span>:                 <span class="k">if</span> <span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>            __pyx_t_5 = __pyx_v_i;
            __pyx_t_6 = __pyx_v_j;
            __pyx_t_7 = (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_delta.data + __pyx_t_5 * __pyx_v_delta.strides[0]) ) + __pyx_t_6 * __pyx_v_delta.strides[1]) ))) &lt; __pyx_v_epsilon) != 0);
            if (__pyx_t_7) {
/* … */
            }
            __pyx_L8_continue:;
          }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">507</span>:                     <span class="k">continue</span></pre>
<pre class='cython code score-0 '>              goto __pyx_L8_continue;
</pre><pre class="cython line score-0">&#xA0;<span class="">508</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">509</span>:             <span class="k">if</span> <span class="n">mi_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>          __pyx_t_7 = ((((PyObject *) __pyx_v_mi_gradient.memview) != Py_None) != 0);
          if (__pyx_t_7) {
/* … */
          }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">510</span>:                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>            __pyx_t_3 = __pyx_v_n;
            for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_3; __pyx_t_4+=1) {
              __pyx_v_k = __pyx_t_4;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">511</span>:                     <span class="n">mi_gradient</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">ssd_grad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2</span></pre>
<pre class='cython code score-0 '>              __pyx_t_8 = __pyx_v_i;
              __pyx_t_9 = __pyx_v_j;
              __pyx_t_10 = __pyx_v_k;
              __pyx_t_11 = __pyx_v_k;
              *((double *) ( /* dim=0 */ (__pyx_v_mi_gradient.data + __pyx_t_11 * __pyx_v_mi_gradient.strides[0]) )) += (((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_delta.data + __pyx_t_8 * __pyx_v_delta.strides[0]) ) + __pyx_t_9 * __pyx_v_delta.strides[1]) ))) * (*((double *) ( /* dim=0 */ (__pyx_v_ssd_grad.data + __pyx_t_10 * __pyx_v_ssd_grad.strides[0]) )))) * 2.0);
            }
</pre><pre class="cython line score-0">&#xA0;<span class="">512</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">513</span>:             <span class="n">delta_2</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mf">2</span></pre>
<pre class='cython code score-0 '>          __pyx_t_12 = __pyx_v_i;
          __pyx_t_13 = __pyx_v_j;
          __pyx_v_delta_2 = pow((*((double *) ( /* dim=1 */ (( /* dim=0 */ (__pyx_v_delta.data + __pyx_t_12 * __pyx_v_delta.strides[0]) ) + __pyx_t_13 * __pyx_v_delta.strides[1]) ))), 2.0);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">514</span>:             <span class="n">metric_value</span> <span class="o">+=</span> <span class="n">delta_2</span></pre>
<pre class='cython code score-0 '>          __pyx_v_metric_value = (__pyx_v_metric_value + __pyx_v_delta_2);
        }
      }
</pre><pre class="cython line score-0">&#xA0;<span class="">515</span>: </pre>
<pre class="cython line score-6" onclick='toggleDiv(this)'>+<span class="">516</span>:     <span class="k">return</span> <span class="n">metric_value</span></pre>
<pre class='cython code score-6 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  __pyx_t_14 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_metric_value);<span class='error_goto'> if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 516, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_14);
  __pyx_r = __pyx_t_14;
  __pyx_t_14 = 0;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">517</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">518</span>: </pre>
<pre class="cython line score-67" onclick='toggleDiv(this)'>+<span class="">519</span>: <span class="k">def</span> <span class="nf">compute_ssd_mi_3d</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span><span class="n">ssd_grad</span><span class="p">,</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="n">delta</span><span class="p">,</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">mi_gradient</span><span class="p">):</span></pre>
<pre class='cython code score-67 '>/* Python wrapper */
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_3compute_ssd_mi_3d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_4dipy_5align_9ssdmetric_2compute_ssd_mi_3d[] = "Computes the ssd and its gradient (if requested)\n\n        Parameters\n        ----------\n        ssd_grad : array, shape (n, )\n        gradient with respect to transformation parameters\n        delta : array, shape (R, C, K)\n        mi_gradient : array, shape (n,)\n        the buffer in which to write the gradient of the mutual information.\n        If None, the gradient is not computed\n    ";
static PyMethodDef __pyx_mdef_4dipy_5align_9ssdmetric_3compute_ssd_mi_3d = {"compute_ssd_mi_3d", (PyCFunction)__pyx_pw_4dipy_5align_9ssdmetric_3compute_ssd_mi_3d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_4dipy_5align_9ssdmetric_2compute_ssd_mi_3d};
static PyObject *__pyx_pw_4dipy_5align_9ssdmetric_3compute_ssd_mi_3d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  __Pyx_memviewslice __pyx_v_ssd_grad = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_delta = { 0, 0, { 0 }, { 0 }, { 0 } };
  __Pyx_memviewslice __pyx_v_mi_gradient = { 0, 0, { 0 }, { 0 }, { 0 } };
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_ssd_mi_3d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_ssd_grad,&amp;__pyx_n_s_delta,&amp;__pyx_n_s_mi_gradient,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
        CYTHON_FALLTHROUGH;
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_ssd_grad)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_delta)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_3d", 1, 3, 3, 1); <span class='error_goto'>__PYX_ERR(0, 519, __pyx_L3_error)</span>
        }
        CYTHON_FALLTHROUGH;
        case  2:
        if (likely((values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s_mi_gradient)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_3d", 1, 3, 3, 2); <span class='error_goto'>__PYX_ERR(0, 519, __pyx_L3_error)</span>
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "compute_ssd_mi_3d") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 519, __pyx_L3_error)</span>
      }
    } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
    }
    __pyx_v_ssd_grad = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(values[0]);<span class='error_goto'> if (unlikely(!__pyx_v_ssd_grad.memview)) __PYX_ERR(0, 519, __pyx_L3_error)</span>
    __pyx_v_delta = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_dsdsds_double</span>(values[1]);<span class='error_goto'> if (unlikely(!__pyx_v_delta.memview)) __PYX_ERR(0, 519, __pyx_L3_error)</span>
    __pyx_v_mi_gradient = <span class='pyx_c_api'>__Pyx_PyObject_to_MemoryviewSlice_ds_double</span>(values[2]);<span class='error_goto'> if (unlikely(!__pyx_v_mi_gradient.memview)) __PYX_ERR(0, 519, __pyx_L3_error)</span>
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("compute_ssd_mi_3d", 1, 3, 3, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 519, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.compute_ssd_mi_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_4dipy_5align_9ssdmetric_2compute_ssd_mi_3d(__pyx_self, __pyx_v_ssd_grad, __pyx_v_delta, __pyx_v_mi_gradient);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_4dipy_5align_9ssdmetric_2compute_ssd_mi_3d(CYTHON_UNUSED PyObject *__pyx_self, __Pyx_memviewslice __pyx_v_ssd_grad, __Pyx_memviewslice __pyx_v_delta, __Pyx_memviewslice __pyx_v_mi_gradient) {
  CYTHON_UNUSED double __pyx_v_epsilon;
  double __pyx_v_metric_value;
  double __pyx_v_delta_2;
  npy_intp __pyx_v_nrows;
  npy_intp __pyx_v_ncols;
  npy_intp __pyx_v_nslices;
  npy_intp __pyx_v_n;
  npy_intp __pyx_v_s;
  npy_intp __pyx_v_i;
  npy_intp __pyx_v_j;
  npy_intp __pyx_v_k;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("compute_ssd_mi_3d", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_24);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("dipy.align.ssdmetric.compute_ssd_mi_3d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_ssd_grad, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_delta, 1);
  __PYX_XDEC_MEMVIEW(&amp;__pyx_v_mi_gradient, 1);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple__58 = <span class='py_c_api'>PyTuple_Pack</span>(14, __pyx_n_s_ssd_grad, __pyx_n_s_delta, __pyx_n_s_mi_gradient, __pyx_n_s_epsilon, __pyx_n_s_metric_value, __pyx_n_s_delta_2, __pyx_n_s_nrows, __pyx_n_s_ncols, __pyx_n_s_nslices, __pyx_n_s_n, __pyx_n_s_s, __pyx_n_s_i, __pyx_n_s_j, __pyx_n_s_k);<span class='error_goto'> if (unlikely(!__pyx_tuple__58)) __PYX_ERR(0, 519, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple__58);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple__58);
/* … */
  __pyx_t_1 = PyCFunction_NewEx(&amp;__pyx_mdef_4dipy_5align_9ssdmetric_3compute_ssd_mi_3d, NULL, __pyx_n_s_dipy_align_ssdmetric);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 519, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_compute_ssd_mi_3d, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 519, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_codeobj__59 = (PyObject*)<span class='pyx_c_api'>__Pyx_PyCode_New</span>(3, 0, 14, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__58, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_dipy_align_ssdmetric_pyx, __pyx_n_s_compute_ssd_mi_3d, 519, __pyx_empty_bytes);<span class='error_goto'> if (unlikely(!__pyx_codeobj__59)) __PYX_ERR(0, 519, __pyx_L1_error)</span>
</pre><pre class="cython line score-0">&#xA0;<span class="">520</span>:     <span class="s">r&quot;&quot;&quot;Computes the ssd and its gradient (if requested)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">521</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">522</span>: <span class="s">        Parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">523</span>: <span class="s">        ----------</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">524</span>: <span class="s">        ssd_grad : array, shape (n, )</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">525</span>: <span class="s">        gradient with respect to transformation parameters</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">526</span>: <span class="s">        delta : array, shape (R, C, K)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">527</span>: <span class="s">        mi_gradient : array, shape (n,)</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">528</span>: <span class="s">        the buffer in which to write the gradient of the mutual information.</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">529</span>: <span class="s">        If None, the gradient is not computed</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">530</span>: <span class="s">    &quot;&quot;&quot;</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">531</span>:     <span class="k">cdef</span><span class="p">:</span></pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">532</span>:         <span class="n">double</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">2.2204460492503131e-016</span></pre>
<pre class='cython code score-0 '>  __pyx_v_epsilon = 2.2204460492503131e-016;
</pre><pre class="cython line score-0">&#xA0;<span class="">533</span>:         <span class="n">double</span> <span class="n">metric_value</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">534</span>:         <span class="n">double</span> <span class="n">delta_2</span></pre>
<pre class="cython line score-0">&#xA0;<span class="">535</span>: </pre>
<pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">536</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nrows</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nrows = (__pyx_v_delta.shape[1]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">537</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_ncols = (__pyx_v_delta.shape[2]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">538</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">nslices</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_nslices = (__pyx_v_delta.shape[0]);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">539</span>:         <span class="n">cnp</span><span class="o">.</span><span class="n">npy_intp</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ssd_grad</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span></pre>
<pre class='cython code score-0 '>  __pyx_v_n = (__pyx_v_ssd_grad.shape[0]);
</pre><pre class="cython line score-98" onclick='toggleDiv(this)'>+<span class="">540</span>:     <span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ssd_grad</span><span class="p">))</span></pre>
<pre class='cython code score-98 '>  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_2, __pyx_n_s_asarray);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __pyx_memoryview_fromslice(__pyx_v_delta, 3, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  __pyx_t_4 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
    __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_2};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_2};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    } else
    #endif
    {
      __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_asarray);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __pyx_memoryview_fromslice(__pyx_v_ssd_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_4 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_2))) {
    __pyx_t_4 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_2);
    if (likely(__pyx_t_4)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_2, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_2)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_5};
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_2)) {
      PyObject *__pyx_temp[2] = {__pyx_t_4, __pyx_t_5};
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_2, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    } else
    #endif
    {
      __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_6);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0+1, __pyx_t_5);
      __pyx_t_5 = 0;
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_2, __pyx_t_6, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, __pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 540, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-4" onclick='toggleDiv(this)'>+<span class="">541</span>:     <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span></pre>
<pre class='cython code score-4 '>  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      <span class='pyx_c_api'>__Pyx_FastGIL_Remember</span>();
      #endif
      /*try:*/ {
/* … */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          <span class='pyx_c_api'>__Pyx_FastGIL_Forget</span>();
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">542</span>:         <span class="n">mi_gradient</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        {
            double __pyx_temp_scalar = 0.0;
            {
                Py_ssize_t __pyx_temp_extent_0 = __pyx_v_mi_gradient.shape[0];
                Py_ssize_t __pyx_temp_stride_0 = __pyx_v_mi_gradient.strides[0];
                char *__pyx_temp_pointer_0;
                Py_ssize_t __pyx_temp_idx_0;
                __pyx_temp_pointer_0 = __pyx_v_mi_gradient.data;
                for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 &lt; __pyx_temp_extent_0; __pyx_temp_idx_0++) {
                  *((double *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
                  __pyx_temp_pointer_0 += __pyx_temp_stride_0;
                }
            }
        }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">543</span>:         <span class="n">metric_value</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_metric_value = 0.0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">544</span>:         <span class="n">delta_2</span> <span class="o">=</span> <span class="mf">0</span></pre>
<pre class='cython code score-0 '>        __pyx_v_delta_2 = 0.0;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">545</span>:         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nslices</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>        __pyx_t_7 = __pyx_v_nslices;
        for (__pyx_t_8 = 0; __pyx_t_8 &lt; __pyx_t_7; __pyx_t_8+=1) {
          __pyx_v_s = __pyx_t_8;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">546</span>:             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>          __pyx_t_9 = __pyx_v_nrows;
          for (__pyx_t_10 = 0; __pyx_t_10 &lt; __pyx_t_9; __pyx_t_10+=1) {
            __pyx_v_i = __pyx_t_10;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">547</span>:                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>            __pyx_t_11 = __pyx_v_ncols;
            for (__pyx_t_12 = 0; __pyx_t_12 &lt; __pyx_t_11; __pyx_t_12+=1) {
              __pyx_v_j = __pyx_t_12;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">548</span>:                     <span class="k">if</span> <span class="n">mi_gradient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span></pre>
<pre class='cython code score-0 '>              __pyx_t_13 = ((((PyObject *) __pyx_v_mi_gradient.memview) != Py_None) != 0);
              if (__pyx_t_13) {
/* … */
              }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">549</span>:                         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>                __pyx_t_14 = __pyx_v_n;
                for (__pyx_t_15 = 0; __pyx_t_15 &lt; __pyx_t_14; __pyx_t_15+=1) {
                  __pyx_v_k = __pyx_t_15;
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">550</span>:                             <span class="n">mi_gradient</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">ssd_grad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2</span></pre>
<pre class='cython code score-0 '>                  __pyx_t_16 = __pyx_v_s;
                  __pyx_t_17 = __pyx_v_i;
                  __pyx_t_18 = __pyx_v_j;
                  __pyx_t_19 = __pyx_v_k;
                  __pyx_t_20 = __pyx_v_k;
                  *((double *) ( /* dim=0 */ (__pyx_v_mi_gradient.data + __pyx_t_20 * __pyx_v_mi_gradient.strides[0]) )) += (((*((double *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_delta.data + __pyx_t_16 * __pyx_v_delta.strides[0]) ) + __pyx_t_17 * __pyx_v_delta.strides[1]) ) + __pyx_t_18 * __pyx_v_delta.strides[2]) ))) * (*((double *) ( /* dim=0 */ (__pyx_v_ssd_grad.data + __pyx_t_19 * __pyx_v_ssd_grad.strides[0]) )))) * 2.0);
                }
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">551</span>:                     <span class="n">delta_2</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mf">2</span></pre>
<pre class='cython code score-0 '>              __pyx_t_21 = __pyx_v_s;
              __pyx_t_22 = __pyx_v_i;
              __pyx_t_23 = __pyx_v_j;
              __pyx_v_delta_2 = pow((*((double *) ( /* dim=2 */ (( /* dim=1 */ (( /* dim=0 */ (__pyx_v_delta.data + __pyx_t_21 * __pyx_v_delta.strides[0]) ) + __pyx_t_22 * __pyx_v_delta.strides[1]) ) + __pyx_t_23 * __pyx_v_delta.strides[2]) ))), 2.0);
</pre><pre class="cython line score-0" onclick='toggleDiv(this)'>+<span class="">552</span>:                     <span class="n">metric_value</span> <span class="o">+=</span> <span class="n">delta_2</span></pre>
<pre class='cython code score-0 '>              __pyx_v_metric_value = (__pyx_v_metric_value + __pyx_v_delta_2);
            }
          }
        }
      }
</pre><pre class="cython line score-143" onclick='toggleDiv(this)'>+<span class="">553</span>:     <span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ssd_grad</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mi_gradient</span><span class="p">))</span></pre>
<pre class='cython code score-143 '>  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_3, __pyx_n_s_asarray);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_delta, 3, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  __pyx_t_6 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_1))) {
    __pyx_t_6 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_1);
    if (likely(__pyx_t_6)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_6);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_6) {
    __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_1, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_1)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_3};
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_1, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_1)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_3};
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_1, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    } else
    #endif
    {
      __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_6); __pyx_t_6 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_2 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_1, __pyx_t_5, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_5, __pyx_n_s_asarray);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __pyx_memoryview_fromslice(__pyx_v_ssd_grad, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_t_6 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_3))) {
    __pyx_t_6 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_3);
    if (likely(__pyx_t_6)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_6);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_6) {
    __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_3, __pyx_t_5);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_5};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_3)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_5};
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_3, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    } else
    #endif
    {
      __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_6); __pyx_t_6 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_5);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0+1, __pyx_t_5);
      __pyx_t_5 = 0;
      __pyx_t_1 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_3, __pyx_t_4, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_n_s_np);<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_PyObject_GetAttrStr</span>(__pyx_t_4, __pyx_n_s_array);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __pyx_memoryview_fromslice(__pyx_v_mi_gradient, 1, (PyObject *(*)(char *)) __pyx_memview_get_double, (int (*)(char *, PyObject *)) __pyx_memview_set_double, 0);;<span class='error_goto'> if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_4);
  __pyx_t_6 = NULL;
  if (CYTHON_UNPACK_METHODS &amp;&amp; unlikely(<span class='py_c_api'>PyMethod_Check</span>(__pyx_t_5))) {
    __pyx_t_6 = <span class='py_macro_api'>PyMethod_GET_SELF</span>(__pyx_t_5);
    if (likely(__pyx_t_6)) {
      PyObject* function = <span class='py_macro_api'>PyMethod_GET_FUNCTION</span>(__pyx_t_5);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_6);
      <span class='pyx_macro_api'>__Pyx_INCREF</span>(function);
      <span class='pyx_macro_api'>__Pyx_DECREF_SET</span>(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_6) {
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_CallOneArg</span>(__pyx_t_5, __pyx_t_4);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
  } else {
    #if CYTHON_FAST_PYCALL
    if (<span class='py_c_api'>PyFunction_Check</span>(__pyx_t_5)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_4};
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    } else
    #endif
    #if CYTHON_FAST_PYCCALL
    if (<span class='pyx_c_api'>__Pyx_PyFastCFunction_Check</span>(__pyx_t_5)) {
      PyObject *__pyx_temp[2] = {__pyx_t_6, __pyx_t_4};
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyCFunction_FastCall</span>(__pyx_t_5, __pyx_temp+1-1, 1+1);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    } else
    #endif
    {
      __pyx_t_24 = <span class='py_c_api'>PyTuple_New</span>(1+1);<span class='error_goto'> if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_24);
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_6); <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_24, 0, __pyx_t_6); __pyx_t_6 = NULL;
      <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_4);
      <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_24, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_PyObject_Call</span>(__pyx_t_5, __pyx_t_24, NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_3);
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_24); __pyx_t_24 = 0;
    }
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_2);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_2);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_1);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 1, __pyx_t_1);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_t_3);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 2, __pyx_t_3);
  __pyx_t_2 = 0;
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;
  if (<span class='pyx_c_api'>__Pyx_PrintOne</span>(0, __pyx_t_5) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 553, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
</pre><pre class="cython line score-6" onclick='toggleDiv(this)'>+<span class="">554</span>:     <span class="k">return</span> <span class="n">metric_value</span></pre>
<pre class='cython code score-6 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  __pyx_t_5 = <span class='py_c_api'>PyFloat_FromDouble</span>(__pyx_v_metric_value);<span class='error_goto'> if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 554, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_5);
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;
</pre><pre class="cython line score-0">&#xA0;<span class="">555</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">556</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">557</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">558</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">559</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">560</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">561</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">562</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">563</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">564</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">565</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">566</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">567</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">568</span>: </pre>
<pre class="cython line score-0">&#xA0;<span class="">569</span>: </pre>
</div></body></html>
